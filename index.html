<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#111111" />
  <meta name="description" content="NephroCalc Pro — Clinical Nephrology Decision Support" />
  <title>NephroCalc Pro</title>
  <link rel="manifest" href="manifest.json" />
</head>
<body>
  <div id="root"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <script type="text/babel">
    const { useState } = React;



// ═══════════════════════════════════════════════════════════════
// © 2026 Dr. Ashish Patel. All rights reserved.
// Peer Reviewers: [                    ] [                    ] [                    ]
//
// PRIMARY SOURCE VERIFICATION LOG
// ─────────────────────────────────────────────────────────────
// #1  CKD-EPI 2021     Inker LA et al. NEJM 2021;385:1737-1749
// #2  Cockcroft-Gault  Cockcroft DW, Gault MH. Nephron 1976;16:31-41
// #3  Schwartz Rev.    Schwartz GJ et al. JASN 2009;20:629-637
// #4  Meas CrCl        Standard renal physiology
// #5  Gen Clearance    Standard renal physiology
// #6  ERPF/PAH         Smith HW. Physiology of the Kidney, 1937
// #7  Filtration Frac. Standard renal physiology
// #8  Net Filt Pres.   Guyton & Hall Medical Physiology
// #9  Starling Eq.     Starling EH. J Physiol 1896;19:312-326
// #10 Oncotic Pres.    Zweifach & Intaglietta. Microvasc Res 1968
// #111 Mehran CIN      Mehran R et al. JACC 2004;44:1393-1399
// #112 McMahon         McMahon GM et al. Ann Intern Med 2013;158:560
// #113 KFRE 4-var      Tangri N et al. JAMA 2011;305:1553-1559
// #114 KFRE 8-var      Tangri N et al. JAMA 2011 (8-var)
// #115 SSIGN           Frank I et al. J Urol 2002;168:2395-2400
// #116 Leibovich       Leibovich BC et al. Cancer 2003;97:1663-1671
// #117 IMDC            Heng DY et al. Lancet Oncol 2009;10:1240-1247
// #118 MSKCC/Motzer    Motzer RJ et al. JCO 1999;17:2530-2540
// #119 RENAL Neph.     Kutikov A, Uzzo RG. J Urol 2009;182:844-853
// #120 STONE Score     Moore CL et al. BMJ 2014;348:g2191
// #121 CP-AKI          Launay-Vacher V et al. (logistic framework)
// #122 Cisplatin AKI   Crona DJ et al. Oncologist 2017 (logistic framework)
// #123 Licurse         Licurse A et al. Arch Intern Med 2010;170:1900
// #124 NRPE            Testani JM et al. Circ Heart Fail 2014
// #125 HIV CKD         Mocroft A et al. Lancet 2003;362:203-209
// #126 CKiD U25        Pierce CB et al. Kidney Int 2021;99:622-630
// #127 MELD            Kamath PS et al. Hepatology 2001;33:464-470
// #128 MELD-Na         Kim WR et al. NEJM 2008;359:1018-1026 (UNOS MELD-Na formula)
// #129 SAAG            Runyon BA et al. Ann Intern Med 1992;117:215-220
// #130 SBP PMN         EASL Guidelines 2018; Rimola et al.
// #131 PRA             Sealey JE, Laragh JH. Hypertension 1990
// #132 ARR             Funder JW et al. JCEM 2016;101:1889-1916
// #133 Renin Phenotype Laragh JH. Am J Med 1978
// #134 PRA Drug Rule   Williams B et al. BMJ 2004;328:634
// #135 RAAS Index      Laragh JH. Am Heart J 1989
// #136 MR Excess       Funder JW et al. JCEM 2016
// #137 Resistant HTN   Carey RM et al. Hypertension 2018;72:e53-e90
// #138 True Resistant  Carey RM et al. Hypertension 2018
// #139 RDN Eligibility Mahfoud F et al. Eur Heart J 2019
// #140 Sympathetic Idx Esler M et al. Hypertension 2010
// #141 RCC T-Stage     AJCC Cancer Staging Manual 8th Ed. 2017
// #142 TNM Composite   AJCC 8th Ed. 2017
// #143 Surgical Rule   Campbell SC et al. J Urol 2009
// #144 RCC Surveillance Motzer RJ et al. NCCN Guidelines
// #145 mRCC Treatment  NCCN/ESMO Guidelines 2023
// #146 Corrected Ca    Payne RB et al. Lancet 1973;2:83-86
// #147 Ca×Phos         KDIGO CKD-MBD Guideline 2017
// #148 PTH Model       KDIGO CKD-MBD 2017
// #149 eGFR-Phos       KDIGO CKD-MBD 2017
// #150 FGF23           Wolf M. J Am Soc Nephrol 2010
// #151 CRS Type 1      Ronco C et al. JACC 2008;52:1527-1539
// #152 CRS Type 2      Ronco C et al. JACC 2008
// #153 FENa Cardiorenal Mullens W et al. JACC 2009
// #154 Renal Venous    Damman K et al. J Am Coll Cardiol 2009
// #155 HRS-AKI         EASL CPG 2018; ICA Consensus 2015
// #156 HRS UNa         Salerno F et al. Hepatology 1993
// #157 HRS FENa        Epstein M. Gastroenterology 1970
// #158 Anti-GBM        Pusey CD. Kidney Int 2003;63:883-889
// #159 ANCA            Jennette JC et al. Arthritis Rheum 2013
// #160 Complement      Sethi S, Fervenza FC. NEJM 2012;366:1119
// #161 Renovascular    Hirsch AT et al. JACC 2006;47:1239-1312
// #162 RAS Hemodynamic Textor SC. Am J Kidney Dis 2009
// #163 TMA             George JN. NEJM 2006;354:1927-1935
// #164 ADAMTS13        Sadler JE. NEJM 2004;351:1227-1235
// #165 PE Proteinuria  ACOG Practice Bulletin 222, 2020 (updated 2022)
// #166 sFlt-1/PlGF     Verlohren S et al. Hypertension 2014;63:346-352 (thresholds)
// Nephrotic Def.       KDIGO Glomerular Diseases 2021
// Selectivity Index    Cameron JS, Blandford G. Lancet 1966
// SAAG                 Runyon BA. Ann Intern Med 1992
// FENa                 KDIGO AKI 2012
// FEUrea               Carvounis CP et al. Kidney Int 2002;62:2223-2229
// Osmolar Gap          Smithline N, Gardner KD. Ann Emerg Med 1976
// Na Deficit           Adrogue HJ, Madias NE. NEJM 2000;342:1581
// SIADH vs CSW FEUrate Fenske W et al. JCEM 2008;93:2991-2997
//                      Maesaka JK et al. Kidney Int 1990;37:1500-1507
//                      Verbalis JG et al. Am J Med 2013;126:S1-S42
//                      NIH clinical reference literature
// Anion Gap corr.      Figge J et al. J Lab Clin Med 1992
// Delta-Delta          Narins RG, Emmett M. Medicine 1980
// Winter's Formula     Albert MS et al. Ann Intern Med 1967;66:312
// Urine Anion Gap      Battle DC et al. NEJM 1988;318:594-599
// STONE Score          Moore CL et al. BMJ 2014;348:g2191
// RIFLE Criteria      Bellomo R et al. Crit Care 2004;8:R204-R212
// KDIGO AKI 2012      Kidney Int Suppl 2012;2:1-138
// Na/Glucose Corr.    Katz MA. NEJM 1973;289:843-844 (factor 1.6)
//                     Hillier TA et al. Am J Med 1999;106:399-403 (factor 2.4)
// Free Water Deficit  Adrogue HJ, Madias NE. NEJM 2000;342:1581
// Henderson-H.        Henderson LJ / Hasselbalch K. pKa=6.1
// MUDPILES/GOLDMARK   Mehta AN et al. Lancet 2008;372:892
// UPCR Staging        KDIGO CKD 2012; ASN recommendations
// RTA Typing          Battle DC et al. NEJM 1988; Rodriguez-Soriano 2002
// Phos/Ca CKD-MBD     KDIGO CKD-MBD 2017; KDOQI 2003
// MELD 3.0            Kim WR et al. Gastroenterology 2022;163:1476-1488
//
// ── TRANSPLANT NEPHROLOGY (v10.0 additions) ──
// S1 CV Screening     KDIGO Transplant Candidacy 2020 §13.3; KDOQI Commentary 2021
// S2 Malig Wait       AST Consensus (Sawinski et al., Am J Transplant 2020); KDIGO 2020 §11
// S3 BMI Assess       KDIGO 2020 §6; KDOQI Commentary 2021
// S4 cPRA/HLA         KDIGO 2020 §19; UNOS cPRA definition
// S5 Fried Frailty    Fried LP et al. J Gerontol 2001;56:M146-M156; KDIGO 2020
// ═══════════════════════════════════════════════════════════════

const GUIDELINE_CLOSING = "In an emergency, stabilise the patient first — calculator outputs must never delay resuscitation. Apply current international and national guidelines alongside your institution’s protocols when making management decisions.";

const DISCLAIMER_TEXT = `IMPORTANT NOTICE — READ CAREFULLY BEFORE USE

© 2026 Dr. Ashish Patel. All rights reserved. Unauthorised reproduction or distribution prohibited.
Peer Reviewers: [                    ] [                    ] [                    ]

EMERGENCY & CRITICAL CARE NOTICE
In haemodynamically unstable patients or clinical emergencies, immediate resuscitation and stabilisation take absolute precedence. The outputs of this tool are not a substitute for emergency clinical assessment and must not delay time-critical interventions including airway management, fluid resuscitation, or organ support.

EVIDENCE BASE & GUIDELINE HIERARCHY
Formulas and thresholds within this tool are derived from primary peer-reviewed literature, systematic reviews, and meta-analyses as cited. Interpretive guidance reflects current applicable recommendations from international bodies including the Kidney Disease: Improving Global Outcomes (KDIGO) initiative, the American Society of Nephrology (ASN), the European Renal Association (ERA), the International Society of Nephrology (ISN), and other relevant national and specialty guidelines. Users are responsible for applying the most current published version of any referenced guideline and adapting recommendations to their national regulatory framework and institutional protocols.

SCOPE OF USE
Results must be interpreted within the full clinical context of the individual patient. No calculator result constitutes a diagnosis, treatment decision, or substitute for the independent clinical judgement of a qualified nephrologist or licensed healthcare professional.

DISCLAIMER OF LIABILITY
Dr. Ashish Patel, the author, peer reviewers (where listed), and all associated developers expressly disclaim any and all liability, to the fullest extent permitted by applicable law, for any clinical decisions, outcomes, or harms arising directly or indirectly from use of this tool. No warranty — express, implied, or statutory — is made regarding the accuracy, completeness, reliability, or fitness for any particular clinical purpose of any formula or output herein.

FORMULA ACCURACY & ONGOING UPDATES
Formulas are derived from peer-reviewed literature and established clinical practice guidelines, as cited in each calculator. However, many equations are mathematical approximations of complex physiological processes and may not be applicable to all patient populations, including patients at extremes of muscle mass or body habitus, paediatric patients outside stated age ranges, critically ill patients with rapidly changing renal function, pregnant patients, patients with unusual dietary patterns, or those with conditions not represented in the original derivation cohort. Clinical practice guidelines, reference ranges, and recommended thresholds are subject to periodic revision as new evidence emerges; the formulas and interpretations within this tool may be updated accordingly but may not always reflect the very latest published revisions. Users should verify against the most current version of any referenced guideline and confirm applicability to their patient population before use.

Use of this tool constitutes acknowledgment and full acceptance of these terms.`;

// ═══════════════════════════════════════════════════════════════
// ALL SECTIONS & CALCULATORS — complete with Transplant Nephrology
// ═══════════════════════════════════════════════════════════════
const SECTIONS = [
  // ─────────────────────────────────────────
  {
    id:"s1", label: "Renal Function & Hemodynamics",
    calcs: [
      {
        id:"ckdepi", name:"CKD-EPI 2021", ref:"#1 · Inker et al., NEJM 2021", tag:"eGFR",
        formula:"142 × min(Scr/κ, 1)^α × max(Scr/κ, 1)^−1.200 × 0.9938^Age × 1.012[Female]\nκ = 0.7 (F) / 0.9 (M)   α = −0.241 (F) / −0.302 (M)",
        note:"Race-free 2021 equation. Preferred adult GFR estimator. Required input for KFRE risk calculation. Do not use in pregnancy, extremes of muscle mass, or acute illness.",
        inputs:[
          {id:"scr",label:"Serum Creatinine",unit:"mg/dL",type:"number",ph:"e.g. 1.2"},
          {id:"age",label:"Age",unit:"years",type:"number",ph:"e.g. 55"},
          {id:"sex",label:"Sex",type:"select",options:["Male","Female"]},
        ],
        compute(v){
          const scr=+v.scr,age=+v.age; if(!scr||scr<=0||!age||age<=0) return null;
          const f=v.sex==="Female",k=f?0.7:0.9,a=f?-0.241:-0.302,r=scr/k;
          return {val:(142*Math.pow(Math.min(r,1),a)*Math.pow(Math.max(r,1),-1.2)*Math.pow(0.9938,age)*(f?1.012:1)).toFixed(1),unit:"mL/min/1.73m²"};
        },
        interpret(r){
          const v=+r.val;
          if(v>=90) return {c:"#16a34a",t:`G1 — Normal or high (≥90 mL/min/1.73m²). A CKD diagnosis at this level would require the presence of kidney damage markers for more than 3 months. Cardiovascular risk factor optimisation is recommended. ${GUIDELINE_CLOSING}`};
          if(v>=60) return {c:"#65a30d",t:`G2 — Mildly decreased (60–89). Annual monitoring is appropriate if damage markers are present. Blood pressure and proteinuria targets should be reviewed. ${GUIDELINE_CLOSING}`};
          if(v>=45) return {c:"#ca8a04",t:`G3a — Mildly-to-moderately decreased (45–59). Six-to-twelve monthly review is reasonable. Monitoring for CKD–Mineral and Bone Disorder, anaemia, and metabolic acidosis is advised. ${GUIDELINE_CLOSING}`};
          if(v>=30) return {c:"#ea580c",t:`G3b — Moderately-to-severely decreased (30–44). Nephrology referral is recommended. Introducing education on renal replacement therapy options may be appropriate in preparation for future planning. ${GUIDELINE_CLOSING}`};
          if(v>=15) return {c:"#dc2626",t:`G4 — Severely decreased (15–29). Expedited nephrology review is strongly recommended. Discussions regarding vascular access planning and transplant assessment, where clinically appropriate, should be considered. ${GUIDELINE_CLOSING}`};
          return {c:"#991b1b",t:`G5 — Kidney failure (<15). Prompt multidisciplinary nephrology input is recommended. Discussions regarding renal replacement therapy or conservative management should be undertaken in accordance with the patient's preferences. ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"cg", name:"Cockcroft–Gault", ref:"#2 · Cockcroft & Gault, Nephron 1976", tag:"CrCl — Drug Dosing",
        formula:"CrCl = [(140 − Age) × Weight] / (72 × Scr) × 0.85 if Female",
        note:"Use actual body weight unless obese (IBW or adjusted BW). Primary equation for dose-adjustment of renally-cleared medications. Not recommended for GFR staging.",
        inputs:[
          {id:"age",label:"Age",unit:"years",type:"number",ph:"e.g. 65"},
          {id:"wt",label:"Weight",unit:"kg",type:"number",ph:"e.g. 70"},
          {id:"scr",label:"Serum Creatinine",unit:"mg/dL",type:"number",ph:"e.g. 1.0"},
          {id:"sex",label:"Sex",type:"select",options:["Male","Female"]},
        ],
        compute(v){
          const age=+v.age,wt=+v.wt,scr=+v.scr; if(!age||!wt||!scr||scr<=0) return null;
          return {val:(((140-age)*wt)/(72*scr)*(v.sex==="Female"?0.85:1)).toFixed(1),unit:"mL/min"};
        },
        interpret(r){
          const v=+r.val;
          if(v>=60) return {c:"#16a34a",t:`≥60 mL/min — Normal range. Standard drug dosing is generally appropriate. Verify against individual drug prescribing information. ${GUIDELINE_CLOSING}`};
          if(v>=30) return {c:"#ca8a04",t:`30–59 mL/min — Moderate renal impairment. Dose adjustment is likely required for many renally-cleared medications including DOACs, aminoglycosides, metformin, and LMWH. Pharmacist review recommended. ${GUIDELINE_CLOSING}`};
          if(v>=15) return {c:"#dc2626",t:`15–29 mL/min — Severe renal impairment. Significant dose reductions likely required. Nephrotoxic agents should be avoided where possible. Pharmacist input and nephrology review are strongly recommended. ${GUIDELINE_CLOSING}`};
          return {c:"#991b1b",t:`<15 mL/min — Dialysis range. Dialysis dosing protocols should be applied. Combined nephrology and pharmacist review is recommended as a priority. ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"schwartz", name:"Revised Schwartz (Paediatric)", ref:"#3 · Schwartz et al., JASN 2009", tag:"Paediatric eGFR",
        formula:"eGFR = 0.413 × (Height / Scr)",
        note:"Height in cm, Scr in mg/dL. Valid for children aged 1–16 years. Do not apply to adults. The 2009 revised equation uses k=0.413.",
        inputs:[
          {id:"ht",label:"Height",unit:"cm",type:"number",ph:"e.g. 120"},
          {id:"scr",label:"Serum Creatinine",unit:"mg/dL",type:"number",ph:"e.g. 0.6"},
        ],
        compute(v){
          const h=+v.ht,s=+v.scr; if(!h||!s||s<=0) return null;
          return {val:(0.413*h/s).toFixed(1),unit:"mL/min/1.73m²"};
        },
        interpret(r){
          const v=+r.val;
          if(v>=90) return {c:"#16a34a",t:`G1 — Normal paediatric GFR (≥90). Kidney damage markers are required for a CKD diagnosis at this eGFR level. ${GUIDELINE_CLOSING}`};
          if(v>=60) return {c:"#65a30d",t:`G2 — Mildly decreased (60–89). Annual monitoring is reasonable if kidney damage markers are present. ${GUIDELINE_CLOSING}`};
          if(v>=30) return {c:"#ca8a04",t:`G3 — Moderately decreased (30–59). Paediatric nephrology referral is recommended. Attention to growth, nutrition, and bone health is advised. ${GUIDELINE_CLOSING}`};
          if(v>=15) return {c:"#dc2626",t:`G4 — Severely decreased (15–29). Prompt paediatric nephrology input is recommended. Family education regarding RRT options should be considered. ${GUIDELINE_CLOSING}`};
          return {c:"#991b1b",t:`G5 — Kidney failure (<15). Urgent paediatric nephrology input is recommended. RRT planning or conservative management discussions should be initiated promptly. ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"ckidu25", name:"CKiD U25 (Pierce 2021)", ref:"#126 · Pierce et al., Kidney Int 2021;99:622-630", tag:"Paediatric & Young Adult eGFR ≤25yr",
        formula:"eGFR = κ × (Height[cm] / Scr[mg/dL])\nSex-stratified κ:\n  Female: 2–11y → 37.2 | 12–17y → 36.5 | 18–25y → 32.8\n  Male:   2–11y → 39.4 | 12–17y → 44.8 | 18–25y → 43.1",
        note:"Age- and sex-stratified κ values. Validated ages 2–25 against iohexol GFR. Requires IDMS-standardised creatinine.",
        inputs:[
          {id:"ht",label:"Height",unit:"cm",type:"number",ph:"e.g. 165"},
          {id:"scr",label:"Serum Creatinine (IDMS-calibrated)",unit:"mg/dL",type:"number",ph:"e.g. 0.9"},
          {id:"age",label:"Age",unit:"years",type:"number",ph:"e.g. 16"},
          {id:"sex",label:"Sex",type:"select",options:["Male","Female"]},
        ],
        compute(v){
          const h=+v.ht,s=+v.scr,age=+v.age; if(!h||!s||s<=0||!age) return null;
          const f=v.sex==="Female";
          let k;
          if(age<=11) k=f?37.2:39.4;
          else if(age<=17) k=f?36.5:44.8;
          else k=f?32.8:43.1;
          return {val:(k*h/s).toFixed(1),unit:"mL/min/1.73m²",sec:`κ = ${k} (${v.sex}, age ${age}yr)`};
        },
        interpret(r){
          const v=+r.val;
          if(v>=90) return {c:"#16a34a",t:`eGFR ${r.val} — G1: Normal or high (≥90). Kidney damage markers needed for CKD diagnosis. ${GUIDELINE_CLOSING}`};
          if(v>=60) return {c:"#65a30d",t:`eGFR ${r.val} — G2: Mildly decreased (60–89). BP and proteinuria optimisation recommended. ${GUIDELINE_CLOSING}`};
          if(v>=45) return {c:"#ca8a04",t:`eGFR ${r.val} — G3a: Mildly-to-moderately decreased (45–59). Nephrology referral appropriate. ${GUIDELINE_CLOSING}`};
          if(v>=30) return {c:"#ea580c",t:`eGFR ${r.val} — G3b: Moderately-to-severely decreased (30–44). Nephrology follow-up recommended. ${GUIDELINE_CLOSING}`};
          if(v>=15) return {c:"#dc2626",t:`eGFR ${r.val} — G4: Severely decreased (15–29). Expedited nephrology input recommended. ${GUIDELINE_CLOSING}`};
          return {c:"#991b1b",t:`eGFR ${r.val} — G5: Kidney failure (<15). Prompt multidisciplinary nephrology input strongly recommended. ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"ckdepi_cys", name:"CKD-EPI Cystatin C & Cr-Cys (2021/2012)", ref:"Inker et al., NEJM 2021;385:1737-1749; NIDDK; NKF-ASN Task Force 2021", tag:"eGFR — Cystatin C (Early Biomarker)",
        formula:"eGFR(Cr-Cys 2021) = 135 × min(Scr/κ,1)^α × max(Scr/κ,1)^−0.544 × min(Scys/0.8,1)^−0.323 × max(Scys/0.8,1)^−0.778 × 0.9961^Age × 0.963[if female]\nκ = 0.7(F) / 0.9(M), α = −0.219(F) / −0.144(M)\n\neGFR(Cys-only 2012) = 133 × min(Scys/0.8,1)^−0.499 × max(Scys/0.8,1)^−1.328 × 0.996^Age × 0.932[if female]",
        note:"Cystatin C is less affected by muscle mass, diet, and race than creatinine — it serves as an early biomarker of GFR decline especially in low muscle mass, elderly, vegetarian, and oncology patients. The combined Cr-Cys equation (P30 ~91%) is the most accurate eGFR estimate and is recommended by KDIGO 2024 and the NKF-ASN Task Force for confirmatory testing. Cystatin C may be elevated by inflammation, thyroid dysfunction, obesity, and corticosteroids. Requires IFCC-standardised assay (ERM-DA471).",
        inputs:[
          {id:"scr",label:"Serum Creatinine (IDMS)",unit:"mg/dL",type:"number",ph:"1.1"},
          {id:"cys",label:"Serum Cystatin C (IFCC)",unit:"mg/L",type:"number",ph:"0.95"},
          {id:"age",label:"Age",unit:"years",type:"number",ph:"55"},
          {id:"sex",label:"Sex",type:"select",options:["Male","Female"]},
        ],
        compute(v){
          const cr=+v.scr,cys=+v.cys,age=+v.age,fem=v.sex==="Female";
          if(!cys||!age) return null;
          const k=fem?0.7:0.9, a=fem?-0.219:-0.144;
          const sexFcrcys=fem?0.963:1, sexFcys=fem?0.932:1;
          let eGFRcys=133*Math.pow(Math.min(cys/0.8,1),-0.499)*Math.pow(Math.max(cys/0.8,1),-1.328)*Math.pow(0.996,age)*sexFcys;
          let eGFRcrcys=null;
          if(cr&&cr>0){
            eGFRcrcys=135*Math.pow(Math.min(cr/k,1),a)*Math.pow(Math.max(cr/k,1),-0.544)*Math.pow(Math.min(cys/0.8,1),-0.323)*Math.pow(Math.max(cys/0.8,1),-0.778)*Math.pow(0.9961,age)*sexFcrcys;
          }
          const best=eGFRcrcys||eGFRcys;
          return {val:best.toFixed(1),unit:"mL/min/1.73m\u00B2",sec:`eGFR(Cys-only): ${eGFRcys.toFixed(1)}${eGFRcrcys?` | eGFR(Cr-Cys): ${eGFRcrcys.toFixed(1)} — preferred`:" | Cr not provided; Cys-only equation used"}`};
        },
        interpret(r,v){
          const gfr=+r.val, cys=+v.cys;
          let stage=gfr>=90?"G1":gfr>=60?"G2":gfr>=45?"G3a":gfr>=30?"G3b":gfr>=15?"G4":"G5";
          let msg=`eGFR ${r.val} mL/min/1.73m\u00B2 (CKD stage ${stage}). `;
          if(cys>1.0&&(!v.scr||+v.scr<1.3)) msg+=`Cystatin C ${cys} mg/L is elevated (ref <0.95) while creatinine remains near-normal — this pattern suggests early GFR decline detectable by cystatin C before creatinine rises (especially relevant in low muscle mass, elderly, or oncology patients). `;
          else if(cys>1.2) msg+=`Cystatin C ${cys} mg/L is elevated. Consider non-GFR determinants: inflammation, thyroid dysfunction, obesity, corticosteroids. `;
          if(v.scr&&+v.scr>0) msg+=`Cr-Cys combined equation used (P30 ~91%, most accurate). `;
          else msg+=`Cys-only equation used. For best accuracy, combine with creatinine. `;
          return {c:gfr>=60?"#16a34a":gfr>=30?"#ca8a04":gfr>=15?"#ea580c":"#dc2626",t:msg+GUIDELINE_CLOSING};
        }
      },
      {
        id:"meas_crcl", name:"Measured Creatinine Clearance", ref:"#4 · Standard renal physiology", tag:"24h Urine CrCl",
        formula:"CrCl = (UCr × V) / PCr\nV = 24h urine volume in mL/min (divide total mL by 1440)",
        note:"Gold-standard timed urine collection. Verify completeness: expected UCr = 15–25 mg/kg/day (men), 10–20 mg/kg/day (women). Overcorrects GFR due to tubular creatinine secretion (~10–20%).",
        inputs:[
          {id:"ucr",label:"Urine Creatinine",unit:"mg/dL",type:"number",ph:"e.g. 60"},
          {id:"vol",label:"24h Urine Volume",unit:"mL",type:"number",ph:"e.g. 1500"},
          {id:"pcr",label:"Plasma Creatinine",unit:"mg/dL",type:"number",ph:"e.g. 1.2"},
        ],
        compute(v){
          const uc=+v.ucr,vol=+v.vol,pc=+v.pcr; if(!uc||!vol||!pc||pc<=0) return null;
          const vpm=vol/1440;
          return {val:((uc*vpm)/pc).toFixed(1),unit:"mL/min",sec:`V = ${vpm.toFixed(3)} mL/min`};
        },
        interpret(r){
          const v=+r.val;
          if(v>=60) return {c:"#16a34a",t:`${r.val} mL/min — Normal clearance. Note: measured CrCl slightly overestimates true GFR due to tubular secretion. ${GUIDELINE_CLOSING}`};
          if(v>=30) return {c:"#ca8a04",t:`${r.val} mL/min — Moderate impairment. Correlate with CKD-EPI eGFR. Check 24h collection completeness. ${GUIDELINE_CLOSING}`};
          return {c:"#dc2626",t:`${r.val} mL/min — Severe impairment. Nephrology review. Verify collection adequacy before clinical use. ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"gen_clear", name:"General Clearance", ref:"#5 · Standard renal physiology", tag:"Renal Clearance Principle",
        formula:"Cx = (Ux × V̇) / Px",
        note:"Fundamental renal clearance equation. Cx = volume of plasma completely cleared of substance X per unit time.",
        inputs:[
          {id:"ux",label:"Urine concentration of X",unit:"mg/dL",type:"number",ph:"e.g. 80"},
          {id:"v",label:"Urine flow rate (V̇)",unit:"mL/min",type:"number",ph:"e.g. 1.04"},
          {id:"px",label:"Plasma concentration of X",unit:"mg/dL",type:"number",ph:"e.g. 1.2"},
        ],
        compute(v){
          const ux=+v.ux,vr=+v.v,px=+v.px; if(!ux||!vr||!px||px<=0) return null;
          return {val:((ux*vr)/px).toFixed(2),unit:"mL/min"};
        },
        interpret(r){
          return {c:"#2563eb",t:`Clearance of X = ${r.val} mL/min. If substance is freely filtered and not secreted/reabsorbed, this approximates GFR. Clearance > GFR → net tubular secretion. Clearance < GFR → net tubular reabsorption.`};
        }
      },
      {
        id:"erpf", name:"ERPF (PAH Clearance)", ref:"#6 · Smith HW, 1937", tag:"Renal Plasma Flow",
        formula:"ERPF = (UPAH × V̇) / PPAH",
        note:"PAH is ~90% extracted in one pass → ERPF ≈ true RPF. Used with GFR to calculate filtration fraction.",
        inputs:[
          {id:"upah",label:"Urine PAH concentration",unit:"mg/dL",type:"number",ph:"e.g. 120"},
          {id:"v",label:"Urine flow rate (V̇)",unit:"mL/min",type:"number",ph:"e.g. 1.04"},
          {id:"ppah",label:"Plasma PAH concentration",unit:"mg/dL",type:"number",ph:"e.g. 0.2"},
        ],
        compute(v){
          const u=+v.upah,vr=+v.v,p=+v.ppah; if(!u||!vr||!p||p<=0) return null;
          return {val:((u*vr)/p).toFixed(0),unit:"mL/min"};
        },
        interpret(r){
          const v=+r.val;
          if(v>=500&&v<=700) return {c:"#16a34a",t:`ERPF ${r.val} mL/min — Within normal range (500–700). ${GUIDELINE_CLOSING}`};
          if(v<500) return {c:"#ea580c",t:`ERPF ${r.val} mL/min — Reduced (<500). Possible causes include reduced renal mass, renovascular disease, volume depletion, cardiorenal syndrome. ${GUIDELINE_CLOSING}`};
          return {c:"#ca8a04",t:`ERPF ${r.val} mL/min — Elevated (>700). May be consistent with early diabetic hyperfiltration or vasodilatory state. ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"ff", name:"Filtration Fraction", ref:"#7 · Standard renal physiology", tag:"Glomerular Hemodynamics",
        formula:"FF = GFR / ERPF",
        note:"Normal FF = 0.15–0.20 (15–20%). Elevated FF suggests efferent arteriolar constriction.",
        inputs:[
          {id:"gfr",label:"GFR",unit:"mL/min",type:"number",ph:"e.g. 120"},
          {id:"erpf",label:"ERPF",unit:"mL/min",type:"number",ph:"e.g. 650"},
        ],
        compute(v){
          const g=+v.gfr,e=+v.erpf; if(!g||!e||e<=0) return null;
          return {val:(g/e*100).toFixed(1),unit:"%"};
        },
        interpret(r){
          const v=+r.val;
          if(v>=15&&v<=20) return {c:"#16a34a",t:`FF ${r.val}% — Normal (15–20%). Glomerular haemodynamics appear intact.`};
          if(v>20) return {c:"#ea580c",t:`FF ${r.val}% — Elevated (>20%). Consistent with efferent arteriolar constriction, early diabetic nephropathy, or nephrotic syndrome. ${GUIDELINE_CLOSING}`};
          return {c:"#ca8a04",t:`FF ${r.val}% — Below normal (<15%). May reflect afferent arteriolar dilation or vasodilatory state. ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"nfp", name:"Net Filtration Pressure", ref:"#8 · Guyton & Hall Medical Physiology", tag:"Glomerular Driving Force",
        formula:"NFP = PGC − PBS − πGC",
        note:"Normal values: PGC ≈ 60 mmHg, PBS ≈ 18 mmHg, πGC ≈ 32 mmHg → NFP ≈ 10 mmHg.",
        inputs:[
          {id:"pgc",label:"PGC — Glomerular capillary hydrostatic pressure",unit:"mmHg",type:"number",ph:"60"},
          {id:"pbs",label:"PBS — Bowman's space hydrostatic pressure",unit:"mmHg",type:"number",ph:"18"},
          {id:"pgc_onc",label:"πGC — Glomerular capillary oncotic pressure",unit:"mmHg",type:"number",ph:"32"},
        ],
        compute(v){
          const pgc=+v.pgc,pbs=+v.pbs,onc=+v.pgc_onc; if(!pgc||!pbs||!onc) return null;
          return {val:(pgc-pbs-onc).toFixed(1),unit:"mmHg"};
        },
        interpret(r){
          const v=+r.val;
          if(v>0) return {c:"#16a34a",t:`NFP = ${r.val} mmHg — Positive. Active filtration occurring.`};
          if(v===0) return {c:"#ca8a04",t:`NFP = 0 mmHg — Filtration equilibrium. GFR = 0 at this point.`};
          return {c:"#dc2626",t:`NFP = ${r.val} mmHg — Negative. Net filtration impossible. Consider elevated PBS (obstruction), reduced PGC (shock), or elevated oncotic pressure.`};
        }
      },
      {
        id:"starling", name:"Starling Equation", ref:"#9 · Starling EH, J Physiol 1896", tag:"Oedema Physiology",
        formula:"Jv = Kf [(Pc − Pi) − σ(πc − πi)]",
        note:"Governs fluid movement across capillary membranes. Relevant to glomerular filtration, pulmonary oedema, and nephrotic oedema.",
        inputs:[
          {id:"pc",label:"Pc — Capillary hydrostatic pressure",unit:"mmHg",type:"number",ph:"35"},
          {id:"pi",label:"Pi — Interstitial hydrostatic pressure",unit:"mmHg",type:"number",ph:"−2"},
          {id:"pic",label:"πc — Capillary oncotic pressure",unit:"mmHg",type:"number",ph:"28"},
          {id:"pii",label:"πi — Interstitial oncotic pressure",unit:"mmHg",type:"number",ph:"5"},
          {id:"sigma",label:"σ — Reflection coefficient (0–1)",unit:"",type:"number",ph:"0.9"},
          {id:"kf",label:"Kf — Filtration coefficient",unit:"mL/min/mmHg",type:"number",ph:"1.0"},
        ],
        compute(v){
          const pc=+v.pc,pi=+v.pi,pic=+v.pic,pii=+v.pii,s=+v.sigma,kf=+v.kf;
          if(!pc||!pic||!s||!kf) return null;
          return {val:(kf*((pc-pi)-s*(pic-pii))).toFixed(2),unit:"mL/min (Jv)"};
        },
        interpret(r){
          const v=+r.val;
          if(v>0) return {c:"#dc2626",t:`Jv = ${r.val} mL/min — Net filtration (fluid leaving capillary). Positive values drive oedema formation.`};
          if(v<0) return {c:"#2563eb",t:`Jv = ${r.val} mL/min — Net reabsorption (fluid returning to capillary).`};
          return {c:"#16a34a",t:`Jv = 0 — Starling equilibrium. No net fluid movement.`};
        }
      },
      {
        id:"oncotic", name:"Oncotic Pressure", ref:"#10 · Zweifach & Intaglietta, Microvasc Res 1968", tag:"Protein Oncotic Force",
        formula:"π = 2.1C + 0.16C² + 0.009C³ (Landis-Pappenheimer)",
        note:"Normal serum oncotic pressure ≈ 25–28 mmHg (albumin ~4 g/dL).",
        inputs:[
          {id:"alb",label:"Albumin concentration",unit:"g/dL",type:"number",ph:"e.g. 2.0"},
        ],
        compute(v){
          const c=+v.alb; if(!c||c<=0) return null;
          return {val:(2.1*c+0.16*c*c+0.009*c*c*c).toFixed(1),unit:"mmHg"};
        },
        interpret(r){
          const v=+r.val;
          if(v>=25) return {c:"#16a34a",t:`π = ${r.val} mmHg — Normal oncotic pressure. Adequate force to retain intravascular fluid.`};
          if(v>=15) return {c:"#ca8a04",t:`π = ${r.val} mmHg — Reduced. Oedema risk increased. Monitor fluid balance.`};
          return {c:"#dc2626",t:`π = ${r.val} mmHg — Severely reduced (<15). Albumin critically low. Profound oedema expected. Consider IV albumin before loop diuretics in refractory nephrotic oedema.`};
        }
      },
    ]
  },

  // ─────────────────────────────────────────
  // II. SODIUM, FLUID & OSMOLALITY,
  // ─────────────────────────────────────────
  {
    id:"s2", label:"Sodium, Fluid & Osmolality",
    calcs:[
      {
        id:"fena", name:"FENa", ref:"KDIGO AKI 2012", tag:"AKI Workup",
        formula:"FENa (%) = [(UNa / PNa) ÷ (UCr / PCr)] × 100",
        note:"Pre-renal: FENa <1%. Intrinsic (ATN): FENa ≥2%. NOT valid on diuretics — use FEUrea instead.",
        inputs:[
          {id:"una",label:"Urine Sodium",unit:"mEq/L",type:"number",ph:"20"},
          {id:"pna",label:"Plasma Sodium",unit:"mEq/L",type:"number",ph:"140"},
          {id:"ucr",label:"Urine Creatinine",unit:"mg/dL",type:"number",ph:"80"},
          {id:"pcr",label:"Plasma Creatinine",unit:"mg/dL",type:"number",ph:"2.0"},
        ],
        compute(v){
          const un=+v.una,pn=+v.pna,uc=+v.ucr,pc=+v.pcr; if(!un||!pn||!uc||!pc||pn<=0||uc<=0) return null;
          return {val:((un/pn)/(uc/pc)*100).toFixed(2),unit:"%"};
        },
        interpret(r){
          const v=+r.val;
          if(v<1) return {c:"#ca8a04",t:"FENa "+r.val+"% (<1%) — Pre-renal pattern or hepatorenal syndrome. Avid sodium retention suggests reduced effective circulating volume. FENa is unreliable on diuretics — use FEUrea instead. "+GUIDELINE_CLOSING};
          if(v<2) return {c:"#f59e0b",t:"FENa "+r.val+"% (1–2%) — Indeterminate. FEUrea, urine microscopy, and full clinical assessment would help clarify. "+GUIDELINE_CLOSING};
          return {c:"#dc2626",t:"FENa "+r.val+"% (≥2%) — Consistent with intrinsic renal AKI (ATN or AIN). Urine microscopy for muddy-brown casts and clinical correlation recommended. "+GUIDELINE_CLOSING};
        }
      },
      {
        id:"feun", name:"FEUrea", ref:"Carvounis et al., NEJM 2002", tag:"AKI on Diuretics",
        formula:"FEUrea (%) = [(UUrea / PUrea) ÷ (UCr / PCr)] × 100",
        note:"Preferred over FENa on diuretics. Pre-renal: <35%.",
        inputs:[
          {id:"uurea",label:"Urine Urea",unit:"mg/dL",type:"number",ph:"300"},
          {id:"puurea",label:"Plasma Urea (BUN)",unit:"mg/dL",type:"number",ph:"20"},
          {id:"ucr",label:"Urine Creatinine",unit:"mg/dL",type:"number",ph:"80"},
          {id:"pcr",label:"Plasma Creatinine",unit:"mg/dL",type:"number",ph:"2.0"},
        ],
        compute(v){
          const uu=+v.uurea,pu=+v.puurea,uc=+v.ucr,pc=+v.pcr; if(!uu||!pu||!uc||!pc||pu<=0||uc<=0) return null;
          return {val:((uu/pu)/(uc/pc)*100).toFixed(1),unit:"%"};
        },
        interpret(r){
          const v=+r.val;
          if(v<35) return {c:"#ca8a04",t:"FEUrea "+r.val+"% (<35%) — Pre-renal pattern. Maximal urea retention. Preferred marker on diuretics. "+GUIDELINE_CLOSING};
          return {c:"#dc2626",t:"FEUrea "+r.val+"% (≥35%) — Consistent with intrinsic renal AKI. Tubular urea-handling impaired. Not significantly affected by diuretics. "+GUIDELINE_CLOSING};
        }
      },
      {
        id:"osmgap", name:"Osmolar Gap", ref:"Smithline & Gardner, Ann Emerg Med 1976", tag:"Toxic Alcohol Screen",
        formula:"Calculated Osm = 2×Na + BUN/2.8 + Glucose/18\nOsmolar Gap = Measured − Calculated",
        note:"Normal ≤10 mOsm/kg. Elevated in toxic alcohols, mannitol, severe uraemia.",
        inputs:[
          {id:"na",label:"Sodium",unit:"mEq/L",type:"number",ph:"140"},
          {id:"bun",label:"BUN",unit:"mg/dL",type:"number",ph:"14"},
          {id:"glc",label:"Glucose",unit:"mg/dL",type:"number",ph:"100"},
          {id:"mosm",label:"Measured Osmolality",unit:"mOsm/kg",type:"number",ph:"295"},
        ],
        compute(v){
          const na=+v.na,bun=+v.bun,glc=+v.glc,mo=+v.mosm; if(!na||!bun||!glc||!mo) return null;
          const calc=2*na+bun/2.8+glc/18;
          return {val:(mo-calc).toFixed(1),unit:"mOsm/kg",sec:"Calculated Osm: "+calc.toFixed(0)+" mOsm/kg"};
        },
        interpret(r){
          const v=+r.val;
          if(v<=10) return {c:"#16a34a",t:"Osmolar gap "+r.val+" mOsm/kg — Normal (≤10). No significant unmeasured osmoles identified. "+GUIDELINE_CLOSING};
          if(v<=20) return {c:"#ca8a04",t:"Osmolar gap "+r.val+" mOsm/kg — Mildly elevated (10–20). Consider early toxic alcohol, mannitol, propylene glycol, or severe uraemia. "+GUIDELINE_CLOSING};
          return {c:"#dc2626",t:"Osmolar gap "+r.val+" mOsm/kg — Significantly elevated (>20). Urgent assessment for toxic alcohol (methanol, ethylene glycol, isopropanol) warranted. Obtain ABG — high AG + high osmolar gap is highly suggestive. "+GUIDELINE_CLOSING};
        }
      },
      {
        id:"nadef", name:"Sodium Deficit", ref:"Adrogue & Madias, NEJM 2000", tag:"Hyponatraemia Correction",
        formula:"Na Deficit = TBW × (Target Na − Current Na)",
        note:"CRITICAL: In chronic hyponatraemia (>48h), correct ≤8–10 mEq/L per 24h to prevent ODS.",
        inputs:[
          {id:"tbw",label:"Total Body Water (TBW)",unit:"L",type:"number",ph:"e.g. 42"},
          {id:"target",label:"Target Sodium",unit:"mEq/L",type:"number",ph:"130"},
          {id:"current",label:"Current Sodium",unit:"mEq/L",type:"number",ph:"115"},
        ],
        compute(v){
          const tbw=+v.tbw,tgt=+v.target,cur=+v.current; if(!tbw||!tgt||!cur) return null;
          return {val:(tbw*(tgt-cur)).toFixed(0),unit:"mEq Na required"};
        },
        interpret(r,v){
          const d=+r.val,rise=+v.target-+v.current;
          if(d<=0) return {c:"#16a34a",t:"No sodium deficit at target. Current Na ≥ target."};
          return {c:"#ea580c",t:r.val+" mEq Na needed to raise by "+rise+" mEq/L. SAFETY: ≤8–10 mEq/L per 24h (chronic hyponatraemia). Monitor Na q2–4h. If overcorrection: DDAVP rescue protocol. "+GUIDELINE_CLOSING};
        }
      },
      {
        id:"nacorr_glucose", name:"Sodium Correction — Hyperglycaemia", ref:"Katz MA. NEJM 1973 | Hillier TA et al. Am J Med 1999", tag:"Corrected Sodium / Hyperglycaemia",
        formula:"Katz 1.6: Corrected Na = Na + 1.6 × [(Glucose − 100) / 100]\nHillier 2.4: Corrected Na = Na + 2.4 × [(Glucose − 100) / 100]",
        note:"Hillier 2.4 preferred at glucose >400 mg/dL.",
        inputs:[
          {id:"na",label:"Measured Sodium",unit:"mEq/L",type:"number",ph:"e.g. 130"},
          {id:"glc",label:"Blood Glucose",unit:"mg/dL",type:"number",ph:"e.g. 450"},
        ],
        compute(v){
          const na=+v.na, glc=+v.glc;
          if(!na||!glc||glc<=100) return null;
          const katz=na+1.6*((glc-100)/100);
          const hillier=na+2.4*((glc-100)/100);
          return {val:katz.toFixed(1),unit:"mEq/L (Katz 1.6)",sec:"Hillier 2.4: "+hillier.toFixed(1)+" mEq/L"};
        },
        interpret(r,v){
          const na=+v.na, glc=+v.glc;
          const katz=na+1.6*((glc-100)/100);
          const hillier=na+2.4*((glc-100)/100);
          const preferred=glc>400?hillier:katz;
          const label=glc>400?"Hillier 2.4":"Katz 1.6";
          if(preferred<135) return {c:"#dc2626",t:"Corrected Na "+preferred.toFixed(1)+" mEq/L ("+label+") — True hyponatraemia after glucose correction. "+GUIDELINE_CLOSING};
          if(preferred<145) return {c:"#16a34a",t:"Corrected Na "+preferred.toFixed(1)+" mEq/L ("+label+") — Normal range. Dilutional hyponatraemia from hyperglycaemia. "+GUIDELINE_CLOSING};
          return {c:"#ca8a04",t:"Corrected Na "+preferred.toFixed(1)+" mEq/L ("+label+") — Hypernatraemia. Significant free water deficit coexisting with hyperglycaemia. "+GUIDELINE_CLOSING};
        }
      },
      {
        id:"fwd", name:"Free Water Deficit", ref:"Adrogue & Madias, NEJM 2000", tag:"Hypernatraemia — Free Water Replacement",
        formula:"FWD = TBW × [(Na / 140) − 1]",
        note:"Correct ≤10–12 mEq/L per 24h to avoid cerebral oedema.",
        inputs:[
          {id:"na",label:"Current Sodium",unit:"mEq/L",type:"number",ph:"e.g. 160"},
          {id:"wt",label:"Weight",unit:"kg",type:"number",ph:"e.g. 70"},
          {id:"sex_age",label:"Sex & Age",type:"select",options:["Male (adult)","Female or elderly male","Elderly female (>65y)"]},
        ],
        compute(v){
          const na=+v.na, wt=+v.wt;
          if(!na||!wt||na<=140) return null;
          const tbwFrac=v.sex_age==="Male (adult)"?0.6:v.sex_age==="Female or elderly male"?0.5:0.45;
          const tbw=tbwFrac*wt;
          const fwd=tbw*((na/140)-1);
          return {val:fwd.toFixed(1),unit:"L free water deficit",sec:"TBW: "+tbw.toFixed(1)+" L"};
        },
        interpret(r,v){
          const fwd=+r.val, na=+v.na;
          const deficit=na-140;
          return {c: deficit>15?"#dc2626":deficit>10?"#ea580c":"#ca8a04",
            t:"Free water deficit approximately "+r.val+" L. Replace over at least "+Math.ceil(deficit/10)*24+"h (≤10–12 mEq/L per 24h). Serial Na q4–6h. "+GUIDELINE_CLOSING};
        }
      },
      {
        id:"csw_siadh", name:"CSW vs SIADH (FEUrate)", ref:"Fenske W et al., JCEM 2008;93:2991-2997; Maesaka JK et al., AJKD 2009;53:775-789", tag:"Hyponatraemia — Cerebral Salt Wasting vs SIADH",
        formula:"FEUrate (%) = (Urine Uric Acid × Serum Creatinine) / (Serum Uric Acid × Urine Creatinine) × 100\n\nDiagnostic thresholds (Fenske JCEM 2008):\n  FEUrate >12% → Cerebral Salt Wasting (CSW)\n  FEUrate <12% → SIADH\n\nAfter correction of hyponatraemia:\n  FEUrate normalises (<10%) → confirms SIADH\n  FEUrate remains elevated (>10%) → confirms CSW or Reset Osmostat",
        note:"Both CSW and SIADH present with euvolaemic/hypovolaemic hypotonic hyponatraemia, low serum osmolality, and inappropriately concentrated urine. FEUrate helps distinguish them when clinical volume assessment is ambiguous.\n\nKey distinguishing features:\n  SIADH: euvolaemic, FEUrate elevated during hyponatraemia but NORMALISES after Na correction\n  CSW: hypovolaemic (often subtle), FEUrate elevated AND REMAINS elevated after Na correction\n\nMaesaka et al. (AJKD 2009) proposed the post-correction FEUrate as the definitive discriminator.\n\nLimitations: Diuretics, chronic kidney disease, and uricosuric drugs interfere with FEUrate interpretation. Ensure labs are drawn OFF diuretics.",
        inputs:[
          {id:"u_ua",label:"Urine Uric Acid",unit:"mg/dL",type:"number",ph:"4.5"},
          {id:"s_ua",label:"Serum Uric Acid",unit:"mg/dL",type:"number",ph:"2.8"},
          {id:"u_cr",label:"Urine Creatinine",unit:"mg/dL",type:"number",ph:"85"},
          {id:"s_cr",label:"Serum Creatinine",unit:"mg/dL",type:"number",ph:"0.9"},
          {id:"corrected",label:"Is hyponatraemia corrected?",type:"select",options:["No — currently hyponatraemic","Yes — Na normalised"]},
        ],
        compute(v){
          const u_ua=+v.u_ua, s_ua=+v.s_ua, u_cr=+v.u_cr, s_cr=+v.s_cr;
          if(!u_ua||!s_ua||!u_cr||!s_cr||s_ua<=0||u_cr<=0) return null;
          const feurate=(u_ua*s_cr)/(s_ua*u_cr)*100;
          return {val:feurate.toFixed(1),unit:"% FEUrate",sec:v.corrected==="Yes — Na normalised"?"Post-correction":"During hyponatraemia"};
        },
        interpret(r,v){
          const fe=+r.val;
          const corrected=v.corrected==="Yes — Na normalised";
          if(!corrected){
            if(fe>12) return {c:"#ea580c",t:`FEUrate ${r.val}% (>12%) during hyponatraemia — suggests Cerebral Salt Wasting (CSW) over SIADH. However, both conditions elevate FEUrate during hyponatraemia. REPEAT FEUrate AFTER Na correction to confirm: if FEUrate normalises (<10%), diagnosis is SIADH; if FEUrate remains elevated (>10%), diagnosis is CSW. Assess volume status carefully — CSW patients are volume-depleted and require isotonic saline, NOT fluid restriction. ${GUIDELINE_CLOSING}`};
            return {c:"#ca8a04",t:`FEUrate ${r.val}% (<12%) during hyponatraemia — favours SIADH. Consider fluid restriction as initial management. Repeat FEUrate after Na correction to confirm: normalisation of FEUrate supports SIADH diagnosis. ${GUIDELINE_CLOSING}`};
          } else {
            if(fe>10) return {c:"#dc2626",t:`FEUrate ${r.val}% remains elevated (>10%) AFTER Na correction — confirms Cerebral Salt Wasting (CSW) or Reset Osmostat (Fenske JCEM 2008; Maesaka AJKD 2009). CSW requires volume repletion with isotonic saline ± fludrocortisone. Fluid restriction (appropriate for SIADH) is CONTRAINDICATED in CSW and may worsen hypovolaemia. ${GUIDELINE_CLOSING}`};
            return {c:"#16a34a",t:`FEUrate ${r.val}% has normalised (≤10%) after Na correction — confirms SIADH (Fenske JCEM 2008; Maesaka AJKD 2009). Continue fluid restriction ± consider vaptan or urea for chronic SIADH if recurrent. ${GUIDELINE_CLOSING}`};
          }
        }
      },
      {
        id:"corrca_glucose", name:"Corrected Calcium (Albumin)", ref:"Payne et al., BMJ 1973; KDIGO CKD-MBD 2017", tag:"Albumin-Adjusted Calcium",
        formula:"Corrected Ca = Measured Ca + 0.8 × (4.0 − Albumin)",
        note:"Albumin-correction correlates imperfectly with ionised calcium, particularly in critical illness. Ionised calcium preferred when accuracy is critical.",
        inputs:[
          {id:"ca",label:"Measured Total Calcium",unit:"mg/dL",type:"number",ph:"e.g. 7.8"},
          {id:"alb",label:"Serum Albumin",unit:"g/dL",type:"number",ph:"e.g. 2.4"},
        ],
        compute(v){
          const ca=+v.ca, alb=+v.alb;
          if(!ca||!alb||ca<=0||alb<=0) return null;
          const corrected=ca+0.8*(4.0-alb);
          return {val:corrected.toFixed(2),unit:"mg/dL (corrected)"};
        },
        interpret(r){
          const v=+r.val;
          if(v<8.5) return {c:"#2563eb",t:"Corrected calcium "+r.val+" mg/dL — Hypocalcaemia. Consider hypoparathyroidism, vitamin D deficiency, hypomagnesaemia, CKD, or pancreatitis. "+GUIDELINE_CLOSING};
          if(v<=10.5) return {c:"#16a34a",t:"Corrected calcium "+r.val+" mg/dL — Normal range (8.5–10.5). "+GUIDELINE_CLOSING};
          return {c:"#ea580c",t:"Corrected calcium "+r.val+" mg/dL — Hypercalcaemia. Consider primary hyperparathyroidism, malignancy, vitamin D toxicity, granulomatous disease. "+GUIDELINE_CLOSING};
        }
      },
    ]
  },

  // ─────────────────────────────────────────
  // III. ACID–BASE,
  // ─────────────────────────────────────────
  {
    id:"s3", label:"Acid–Base",
    calcs:[
      {
        id:"henderson_h", name:"Henderson–Hasselbalch / Blood Gas Interpreter", ref:"Henderson 1908 / Hasselbalch 1916", tag:"ABG Acid-Base Interpretation",
        formula:"pH = 6.1 + log([HCO₃] / (0.0301 × PaCO₂))",
        note:"Foundation of blood gas interpretation. Henderson equation: [H⁺] = 24 × PCO₂/HCO₃.",
        inputs:[
          {id:"ph",label:"Measured pH (if available)",unit:"",type:"number",ph:"7.40"},
          {id:"hco3",label:"HCO₃",unit:"mEq/L",type:"number",ph:"24"},
          {id:"pco2",label:"PaCO₂",unit:"mmHg",type:"number",ph:"40"},
        ],
        compute(v){
          const hco3=+v.hco3, pco2=+v.pco2;
          if(!hco3||!pco2||hco3<=0||pco2<=0) return null;
          const calcPH=(6.1+Math.log10(hco3/(0.0301*pco2)));
          const hplus=24*pco2/hco3;
          const measPH=+v.ph;
          return {val:calcPH.toFixed(2),unit:"calculated pH",sec:`[H⁺]: ${hplus.toFixed(0)} nmol/L${measPH?` | Measured: ${measPH} | Δ: ${Math.abs(calcPH-measPH).toFixed(3)}`:""}`};
        },
        interpret(r,v){
          const pH=+r.val, hco3=+v.hco3, pco2=+v.pco2;
          let disorder="";
          if(pH<7.35&&pco2>45) disorder="Respiratory acidosis";
          else if(pH<7.35&&hco3<22) disorder="Metabolic acidosis";
          else if(pH>7.45&&pco2<35) disorder="Respiratory alkalosis";
          else if(pH>7.45&&hco3>26) disorder="Metabolic alkalosis";
          else disorder="pH normal — possible compensated disorder";
          return {c:pH<7.35?"#dc2626":pH>7.45?"#7c3aed":"#16a34a",
            t:`pH ${r.val} | Pattern: ${disorder}. Winter's expected PaCO₂: ${(1.5*hco3+8).toFixed(0)} ± 2 mmHg. Full analysis should incorporate AG, delta-delta, and compensation assessment. ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"agap", name:"Anion Gap (Albumin-Corrected)", ref:"Figge et al., J Lab Clin Med 1992", tag:"HAGMA Screen",
        formula:"AG = Na − (Cl + HCO₃)\nCorrected AG = AG + 2.5 × (4.0 − Albumin)",
        note:"Always correct for hypoalbuminaemia. Each 1 g/dL fall reduces AG by ~2.5.",
        inputs:[
          {id:"na",label:"Sodium",unit:"mEq/L",type:"number",ph:"140"},
          {id:"cl",label:"Chloride",unit:"mEq/L",type:"number",ph:"102"},
          {id:"hco3",label:"Bicarbonate",unit:"mEq/L",type:"number",ph:"24"},
          {id:"alb",label:"Albumin",unit:"g/dL",type:"number",ph:"4.0"},
        ],
        compute(v){
          const na=+v.na,cl=+v.cl,hco3=+v.hco3,alb=+v.alb; if(!na||!cl||!hco3) return null;
          const ag=na-cl-hco3, corr=alb?ag+2.5*(4.0-alb):ag;
          return {val:corr.toFixed(1),unit:"mEq/L",sec:`Raw AG: ${ag}`};
        },
        interpret(r){
          const v=+r.val;
          if(v<=12) return {c:"#16a34a",t:`Corrected AG ${r.val} — Normal (≤12). If acidosis present, non-anion gap (hyperchloraemic) pattern. Consider GI loss, RTA, saline excess. ${GUIDELINE_CLOSING}`};
          if(v<=20) return {c:"#ca8a04",t:`Corrected AG ${r.val} — Elevated (12–20). HAGMA. MUDPILES differential: Methanol, Uraemia, DKA/AKA, Propylene glycol, Isoniazid/Iron, Lactic acidosis, Ethylene glycol, Salicylates. ${GUIDELINE_CLOSING}`};
          return {c:"#dc2626",t:`Corrected AG ${r.val} — Markedly elevated (>20). Severe HAGMA. Urgent: lactate, ketones, salicylate, osmolar gap. ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"delta", name:"Delta–Delta Ratio", ref:"Narins & Emmett, Medicine 1980", tag:"Mixed Acid-Base Detection",
        formula:"ΔΔ = (AG − 12) ÷ (24 − HCO₃)",
        note:"<1: concurrent NAGMA. >2: concurrent metabolic alkalosis. 1–2: pure HAGMA.",
        inputs:[
          {id:"ag",label:"Corrected Anion Gap",unit:"mEq/L",type:"number",ph:"24"},
          {id:"hco3",label:"Measured HCO₃",unit:"mEq/L",type:"number",ph:"18"},
        ],
        compute(v){
          const ag=+v.ag,hco3=+v.hco3; if(!ag||!hco3||ag<=12) return null;
          return {val:((ag-12)/(24-hco3)).toFixed(2),unit:"ratio"};
        },
        interpret(r){
          const v=+r.val;
          if(v<1.0) return {c:"#ca8a04",t:`ΔΔ ${r.val} (<1.0) — Mixed HAGMA and non-anion gap metabolic acidosis. ${GUIDELINE_CLOSING}`};
          if(v<=2.0) return {c:"#16a34a",t:`ΔΔ ${r.val} (1.0–2.0) — Pure HAGMA. Bicarbonate fell proportionally to AG rise. ${GUIDELINE_CLOSING}`};
          return {c:"#7c3aed",t:`ΔΔ ${r.val} (>2.0) — Concurrent metabolic alkalosis masking acidosis severity. ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"winters", name:"Winter's Formula", ref:"Albert et al., Ann Intern Med 1967", tag:"Respiratory Compensation Check",
        formula:"Expected PaCO₂ = (1.5 × HCO₃) + 8 ± 2",
        note:"Predicts respiratory compensation in pure metabolic acidosis.",
        inputs:[
          {id:"hco3",label:"HCO₃",unit:"mEq/L",type:"number",ph:"12"},
          {id:"pco2",label:"Measured PaCO₂",unit:"mmHg",type:"number",ph:"28"},
        ],
        compute(v){
          const hco3=+v.hco3; if(!hco3||hco3<=0) return null;
          const exp=1.5*hco3+8;
          return {val:`${(exp-2).toFixed(0)}–${(exp+2).toFixed(0)}`,unit:"mmHg",sec:v.pco2?`Measured: ${v.pco2} mmHg`:""};
        },
        interpret(r,v){
          const hco3=+v.hco3,pco2=+v.pco2,exp=1.5*hco3+8;
          if(!pco2) return {c:"#6b7280",t:`Expected PaCO₂: ${(exp-2).toFixed(0)}–${(exp+2).toFixed(0)} mmHg. Enter measured PaCO₂ to check for concurrent respiratory disorder.`};
          if(pco2>exp+2) return {c:"#dc2626",t:`PaCO₂ ${pco2} above expected (${(exp-2).toFixed(0)}–${(exp+2).toFixed(0)}) — concurrent respiratory acidosis. ${GUIDELINE_CLOSING}`};
          if(pco2<exp-2) return {c:"#7c3aed",t:`PaCO₂ ${pco2} below expected — concurrent respiratory alkalosis. ${GUIDELINE_CLOSING}`};
          return {c:"#16a34a",t:`PaCO₂ ${pco2} within expected range — appropriate compensation for pure metabolic acidosis. ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"uag", name:"Urine Anion Gap", ref:"Battle et al., NEJM 1988", tag:"RTA vs GI Loss",
        formula:"UAG = UNa + UK − UCl",
        note:"Negative = high NH₄⁺ = GI loss. Positive = low NH₄⁺ = RTA.",
        inputs:[
          {id:"una",label:"Urine Na",unit:"mEq/L",type:"number",ph:"40"},
          {id:"uk",label:"Urine K",unit:"mEq/L",type:"number",ph:"20"},
          {id:"ucl",label:"Urine Cl",unit:"mEq/L",type:"number",ph:"35"},
        ],
        compute(v){
          const un=+v.una,uk=+v.uk,uc=+v.ucl; if(!un||!uk||!uc) return null;
          return {val:(un+uk-uc).toFixed(0),unit:"mEq/L"};
        },
        interpret(r){
          const v=+r.val;
          if(v<0) return {c:"#16a34a",t:`UAG ${r.val} — Negative. Intact renal acidification. NAGMA likely from GI bicarbonate loss (diarrhoea, fistula). ${GUIDELINE_CLOSING}`};
          return {c:"#dc2626",t:`UAG ${r.val} — Positive. Impaired NH₄⁺ excretion consistent with RTA. Type 1 (distal, urine pH >5.5), Type 2 (proximal), or Type 4 (hyperkalaemic). ${GUIDELINE_CLOSING}`};
        }
      },
    ]
  },

  // ─────────────────────────────────────────
  // IV. AKI & RISK SCORES,
  // ─────────────────────────────────────────
  {
    id:"s4", label:"AKI & Risk Scores",
    calcs:[
      {
        id:"mehran", name:"Mehran CIN Score", ref:"Mehran et al., JACC 2004", tag:"Contrast-Induced AKI",
        formula:"Score = 5(Hypotension) + 5(IABP) + 5(CHF) + 4(Age>75) + 3(Anaemia) + 3(DM) + 4(Cr>1.5) + ⌊Vol/100⌋",
        note:"≤5 ~7.5%, 6–10 ~14%, 11–15 ~26%, ≥16 ~57% CIN risk.",
        inputs:[
          {id:"htn",label:"Hypotension (SBP <80 ≥1h / vasopressors)",type:"checkbox"},
          {id:"iabp",label:"IABP in use",type:"checkbox"},
          {id:"chf",label:"CHF (NYHA III–IV / pulmonary oedema)",type:"checkbox"},
          {id:"age75",label:"Age >75",type:"checkbox"},
          {id:"anaemia",label:"Anaemia (Hct <39% M, <36% F)",type:"checkbox"},
          {id:"dm",label:"Diabetes",type:"checkbox"},
          {id:"cr15",label:"Creatinine >1.5 mg/dL",type:"checkbox"},
          {id:"contrast",label:"Contrast Volume",unit:"mL",type:"number",ph:"150"},
        ],
        compute(v){
          let s=0;
          if(v.htn) s+=5; if(v.iabp) s+=5; if(v.chf) s+=5;
          if(v.age75) s+=4; if(v.anaemia) s+=3; if(v.dm) s+=3; if(v.cr15) s+=4;
          const c=+v.contrast; if(c>0) s+=Math.floor(c/100);
          return {val:s,unit:"points"};
        },
        interpret(r){
          const v=r.val;
          if(v<=5) return {c:"#16a34a",t:`Score ${v} (≤5) — Low CIN risk (~7.5%). Standard hydration. ${GUIDELINE_CLOSING}`};
          if(v<=10) return {c:"#ca8a04",t:`Score ${v} (6–10) — Moderate risk (~14%). Aggressive IV saline hydration. Minimise contrast. ${GUIDELINE_CLOSING}`};
          if(v<=15) return {c:"#ea580c",t:`Score ${v} (11–15) — High risk (~26%). Maximal prophylaxis. Consider non-contrast alternatives. ${GUIDELINE_CLOSING}`};
          return {c:"#dc2626",t:`Score ${v} (≥16) — Very high risk (~57%). Non-contrast alternatives strongly preferred. ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"rifle_kdigo", name:"RIFLE & KDIGO AKI Staging", ref:"Bellomo et al., Crit Care 2004; KDIGO AKI 2012", tag:"AKI Classification",
        formula:"KDIGO: Stage 1: Cr ×1.5–1.9 or ↑≥0.3 | Stage 2: ×2.0–2.9 | Stage 3: ×3.0 or ≥4.0 or RRT",
        note:"KDIGO 2012 supersedes RIFLE. Baseline = lowest value within 3 months.",
        inputs:[
          {id:"scr_base",label:"Baseline Creatinine",unit:"mg/dL",type:"number",ph:"0.9"},
          {id:"scr_now",label:"Current Creatinine",unit:"mg/dL",type:"number",ph:"2.7"},
          {id:"scr_48h",label:"Creatinine 48h ago (if available)",unit:"mg/dL",type:"number",ph:"1.1"},
          {id:"rrt",label:"Renal Replacement Therapy initiated?",type:"select",options:["No","Yes — auto Stage 3"]},
        ],
        compute(v){
          const base=+v.scr_base, now=+v.scr_now, s48=+v.scr_48h;
          if(!base||!now) return null;
          const ratio=now/base;
          const rise48=(s48>0)?(now-s48):0;
          let stage=0;
          if(ratio>=3||now>=4.0||v.rrt==="Yes — auto Stage 3") stage=3;
          else if(ratio>=2.0) stage=2;
          else if(ratio>=1.5||rise48>=0.3) stage=1;
          return {val:stage===0?"No AKI":stage,unit:stage===0?"":"KDIGO Stage",sec:`Ratio: ${ratio.toFixed(2)}×`};
        },
        interpret(r,v){
          const stage=r.val;
          if(stage==="No AKI") return {c:"#16a34a",t:`No AKI criteria met. Monitor if clinical suspicion. ${GUIDELINE_CLOSING}`};
          const info={
            1:{c:"#ca8a04",t:`KDIGO Stage 1. Nephrotoxin review, dose adjustment, haemodynamic assessment. ${GUIDELINE_CLOSING}`},
            2:{c:"#ea580c",t:`KDIGO Stage 2. Prompt nephrology review. Nephrotoxin avoidance, haemodynamic optimisation. ${GUIDELINE_CLOSING}`},
            3:{c:"#dc2626",t:`KDIGO Stage 3 — Severe AKI. Urgent nephrology input. Consider RRT. ${GUIDELINE_CLOSING}`},
          };
          return info[stage]||{c:"#6b7280",t:"Verify inputs."};
        }
      },
      {
        id:"ain_risk", name:"Acute Interstitial Nephritis (AIN) Risk Calculator", ref:"Moledina DG et al., Nephrol Dial Transplant 2022;37:2214-2222; Moledina DG et al., JASN 2024 (external validation)", tag:"AIN — Biopsy Decision Support",
        formula:"Sum = 0.8367518 × ln(Cr) + (−0.9181938 × ln(BUN÷Cr)) + (−0.0501203 × 1000 × (SG − 1)) + protein_coeff + 0.770398 + ln(prevalence÷0.23)\nProtein coefficient = 0.9360127 if dipstick ≤1+, else 0\n% Probability of AIN = 100 × e^sum ÷ (1 + e^sum)\n\nAUC: 0.78 (training), 0.73 (internal validation), 0.74 (external BBCI cohort)",
        note:"Validated 4-variable logistic regression model identifies patients at risk of biopsy-proven AIN using EHR data. Developed at Yale (n=393, 86 AIN on biopsy), externally validated in the Biopsy Biobank Cohort Initiative (BBCI; n=1118, 119 AIN) and again in JASN 2024. Higher probability indicates greater likelihood of AIN on biopsy, guiding decisions about who should undergo kidney biopsy. Particularly helpful with atypical or subclinical presentations where the classic triad (rash, fever, eosinophilia) is absent (~90% of cases). AIN accounts for 15-27% of unexplained AKI on biopsy. Most common culprits: PPIs, antibiotics, NSAIDs, checkpoint inhibitors. Treatment: withdraw offending drug; if no Cr recovery in 5-7 days, start prednisone 1 mg/kg (Gonzalez, Kidney Int 2008 — earlier steroids improve recovery).",
        inputs:[
          {id:"cr",label:"Serum Creatinine",unit:"mg/dL",type:"number",ph:"2.5"},
          {id:"bun",label:"Blood Urea Nitrogen (BUN)",unit:"mg/dL",type:"number",ph:"28"},
          {id:"usg",label:"Urine Specific Gravity (dipstick)",unit:"",type:"number",ph:"1.012"},
          {id:"u_protein",label:"Urine Dipstick Protein",type:"select",options:["1+ or lower","2+ or higher"]},
          {id:"prevalence",label:"Local AIN prevalence among biopsies (derivation cohort: 0.23; varies by centre, e.g. JHH 0.05, Yale 0.17)",unit:"",type:"number",ph:"0.23"},
        ],
        compute(v){
          const cr=+v.cr, bun=+v.bun, sg=+v.usg, prev=+v.prevalence||0.23;
          if(!cr||!bun||!sg||cr<=0||bun<=0||sg<1.0||sg>1.050) return null;
          const bunCrRatio=bun/cr;
          const protCoeff=v.u_protein==="1+ or lower"?0.9360127:0;
          const sum=0.8367518*Math.log(cr)+(-0.9181938*Math.log(bunCrRatio))+(-0.0501203*1000*(sg-1))+protCoeff+0.770398+Math.log(prev/0.23);
          const prob=100*(Math.exp(sum)/(1+Math.exp(sum)));
          return {val:prob.toFixed(1),unit:"% probability of AIN on biopsy",sec:`BUN:Cr ratio: ${bunCrRatio.toFixed(1)} | SG: ${sg} | Protein: ${v.u_protein} | Local prevalence: ${prev}`};
        },
        interpret(r,v){
          const prob=+r.val;
          const cr=+v.cr, bun=+v.bun;
          const ratio=bun/cr;
          let msg=`AIN probability: ${r.val}% (Moledina model, AUC 0.73–0.78). `;
          if(prob>=50) return {c:"#dc2626",t:msg+`HIGH probability of AIN on biopsy. Features favouring AIN: ${cr>1.5?"elevated creatinine, ":""}${ratio<20?"low BUN:Cr ratio (intrinsic renal pattern), ":""}${v.u_protein==="1+ or lower"?"absent or minimal proteinuria (typical of AIN). ":""}Strong indication for kidney biopsy. Withdraw suspected drug immediately (PPIs, antibiotics, NSAIDs, checkpoint inhibitors). If biopsy confirms AIN and no Cr improvement in 5-7 days, initiate prednisone 1 mg/kg/day. ${GUIDELINE_CLOSING}`};
          if(prob>=25) return {c:"#ea580c",t:msg+`MODERATE probability. Consider kidney biopsy, especially if AKI is unexplained or a steroid-responsive AIN diagnosis would change management. Review medications for culprit drugs (PPIs are now the most common cause). ${GUIDELINE_CLOSING}`};
          if(prob>=10) return {c:"#ca8a04",t:msg+`LOW-MODERATE probability. AIN less likely but cannot be excluded. Monitor renal function closely. If AKI persists or worsens without clear aetiology, reconsider biopsy. ${GUIDELINE_CLOSING}`};
          return {c:"#16a34a",t:msg+`LOW probability of AIN. Consider alternative diagnoses (ATN, pre-renal, obstructive). ${GUIDELINE_CLOSING}`};
        }
      },

    ]
  },

  // ─────────────────────────────────────────
  // V. KIDNEY FAILURE RISK — KFRE,
  // ─────────────────────────────────────────
  {
    id:"s5", label:"Kidney Failure Risk — KFRE",
    calcs:[
      {
        id:"kfre4", name:"KFRE 4-Variable", ref:"Tangri et al., JAMA 2011", tag:"2yr & 5yr ESRD Probability",
        formula:"Risk₂ᵧᵣ = 1 − 0.9832^exp(LP)\nLP = −0.2201(Age/10−7.036) + 0.2467(Male−0.5642) − 0.5567(eGFR/5−7.222) + 0.4510(lnACR−5.137)",
        note:"ACR in mg/g. Validated CKD G3–G5. Guides timing of access creation and transplant referral.",
        inputs:[
          {id:"age",label:"Age",unit:"years",type:"number",ph:"60"},
          {id:"sex",label:"Sex",type:"select",options:["Male","Female"]},
          {id:"egfr",label:"eGFR",unit:"mL/min/1.73m²",type:"number",ph:"25"},
          {id:"acr",label:"Urine ACR",unit:"mg/g",type:"number",ph:"300"},
        ],
        compute(v){
          const age=+v.age,egfr=+v.egfr,acr=+v.acr; if(!age||!egfr||!acr||acr<=0) return null;
          const m=v.sex==="Male"?1:0;
          const lp=-0.2201*(age/10-7.036)+0.2467*(m-0.5642)-0.5567*(egfr/5-7.222)+0.4510*(Math.log(acr)-5.137);
          const r2=(1-Math.pow(0.9832,Math.exp(lp)))*100, r5=(1-Math.pow(0.9365,Math.exp(lp)))*100;
          return {val:r2.toFixed(1),unit:"% 2yr risk",sec:`5yr: ${r5.toFixed(1)}%`};
        },
        interpret(r){
          const v=+r.val;
          if(v<3) return {c:"#16a34a",t:`2yr risk ${r.val}% — Low. Optimise modifiable risk factors. ${GUIDELINE_CLOSING}`};
          if(v<10) return {c:"#ca8a04",t:`2yr risk ${r.val}% — Moderate. Nephrology referral. Begin RRT education. ${GUIDELINE_CLOSING}`};
          if(v<25) return {c:"#ea580c",t:`2yr risk ${r.val}% — High. Active RRT preparation. Access planning and transplant referral. ${GUIDELINE_CLOSING}`};
          return {c:"#dc2626",t:`2yr risk ${r.val}% — Very high. Urgent MDT input. Prioritise access and transplant listing. ${GUIDELINE_CLOSING}`};
        }
      },
    ]
  },

  // ─────────────────────────────────────────
  // VI. CKD-MBD,
  // ─────────────────────────────────────────
  {
    id:"s6", label:"CKD-MBD",
    calcs:[
      {
        id:"corrca", name:"Corrected Calcium", ref:"Payne et al., BMJ 1973", tag:"Albumin-Adjusted Calcium",
        formula:"Corrected Ca = Measured Ca + 0.8 × (4.0 − Albumin)",
        note:"Ionised calcium preferred in critical illness.",
        inputs:[
          {id:"ca",label:"Measured Total Calcium",unit:"mg/dL",type:"number",ph:"7.8"},
          {id:"alb",label:"Albumin",unit:"g/dL",type:"number",ph:"2.5"},
        ],
        compute(v){
          const ca=+v.ca,alb=+v.alb; if(!ca||!alb) return null;
          return {val:(ca+0.8*(4-alb)).toFixed(2),unit:"mg/dL"};
        },
        interpret(r){
          const v=+r.val;
          if(v<8.5) return {c:"#dc2626",t:`Corrected Ca ${r.val} — Hypocalcaemia. Check PTH, vitamin D, phosphate. ${GUIDELINE_CLOSING}`};
          if(v>10.5) return {c:"#ea580c",t:`Corrected Ca ${r.val} — Hypercalcaemia. Review calcium binders and vitamin D. ${GUIDELINE_CLOSING}`};
          return {c:"#16a34a",t:`Corrected Ca ${r.val} — Normal (8.5–10.5). ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"caphos", name:"Calcium–Phosphate Product", ref:"KDIGO CKD-MBD 2017", tag:"Vascular Calcification Risk",
        formula:"Ca × Phosphate (both mg/dL)",
        note:">55 mg²/dL² associated with elevated CV mortality in dialysis.",
        inputs:[
          {id:"ca",label:"Corrected Calcium",unit:"mg/dL",type:"number",ph:"9.5"},
          {id:"phos",label:"Phosphate",unit:"mg/dL",type:"number",ph:"5.5"},
        ],
        compute(v){
          const ca=+v.ca,p=+v.phos; if(!ca||!p) return null;
          return {val:(ca*p).toFixed(1),unit:"mg²/dL²"};
        },
        interpret(r){
          const v=+r.val;
          if(v<55) return {c:"#16a34a",t:`Ca×Phos ${r.val} — Below 55. Continue mineral management. ${GUIDELINE_CLOSING}`};
          return {c:"#dc2626",t:`Ca×Phos ${r.val} — Elevated (>55). Significant calcification risk. Restrict dietary phosphate, non-calcium binders preferred. ${GUIDELINE_CLOSING}`};
        }
      },
    ]
  },

  // ─────────────────────────────────────────
  // VII. HEPATO-RENAL & ASCITES,
  // ─────────────────────────────────────────
  {
    id:"s7", label:"Hepato-Renal & Ascites",
    calcs:[
      {
        id:"meld", name:"MELD Score", ref:"Kamath et al., Hepatology 2001", tag:"Liver Disease Severity",
        formula:"MELD = 3.78×ln(Bili) + 11.2×ln(INR) + 9.57×ln(Cr) + 6.43",
        note:"Liver transplant allocation. Cr capped at 4.0. If dialysis ≥2×/week set Cr = 4.0.",
        inputs:[
          {id:"bili",label:"Bilirubin",unit:"mg/dL",type:"number",ph:"2.5"},
          {id:"inr",label:"INR",unit:"",type:"number",ph:"1.8"},
          {id:"cr",label:"Creatinine",unit:"mg/dL",type:"number",ph:"1.5"},
        ],
        compute(v){
          const bi=+v.bili,ir=+v.inr,cr=+v.cr; if(!bi||!ir||!cr) return null;
          const B=Math.max(bi,1),I=Math.max(ir,1),C=Math.min(Math.max(cr,1),4);
          return {val:Math.round(3.78*Math.log(B)+11.2*Math.log(I)+9.57*Math.log(C)+6.43),unit:"points"};
        },
        interpret(r){
          const v=r.val;
          if(v<10) return {c:"#16a34a",t:`MELD ${v} — 90-day mortality ~2%. ${GUIDELINE_CLOSING}`};
          if(v<20) return {c:"#ca8a04",t:`MELD ${v} — 90-day mortality ~6%. Consider transplant evaluation. ${GUIDELINE_CLOSING}`};
          if(v<30) return {c:"#ea580c",t:`MELD ${v} — 90-day mortality ~20%. High transplant priority. ${GUIDELINE_CLOSING}`};
          return {c:"#dc2626",t:`MELD ${v} — 90-day mortality >50%. Urgent transplant. ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"saag", name:"SAAG", ref:"Runyon et al., Ann Intern Med 1992", tag:"Portal vs Non-Portal Ascites",
        formula:"SAAG = Serum Albumin − Ascites Albumin\n≥1.1 = portal hypertension (97% accuracy)",
        note:"Simultaneous samples required.",
        inputs:[
          {id:"salb",label:"Serum Albumin",unit:"g/dL",type:"number",ph:"3.8"},
          {id:"aalb",label:"Ascites Albumin",unit:"g/dL",type:"number",ph:"1.2"},
        ],
        compute(v){
          const s=+v.salb,a=+v.aalb; if(!s||!a) return null;
          return {val:(s-a).toFixed(2),unit:"g/dL"};
        },
        interpret(r){
          const v=+r.val;
          if(v>=1.1) return {c:"#7c3aed",t:`SAAG ${r.val} ≥1.1 — Portal hypertension (97% accuracy). Cirrhosis, cardiac ascites, Budd-Chiari. ${GUIDELINE_CLOSING}`};
          return {c:"#ea580c",t:`SAAG ${r.val} <1.1 — Non-portal. Exudative: peritoneal malignancy, TB, pancreatitis. ${GUIDELINE_CLOSING}`};
        }
      },
    ]
  },

  // ─────────────────────────────────────────
  // VIII. NEPHROTIC SYNDROME,
  // ─────────────────────────────────────────
  {
    id:"s8", label:"Nephrotic Syndrome",
    calcs:[
      {
        id:"upcr_staging", name:"UPCR & Proteinuria Staging", ref:"KDIGO CKD 2012; KDIGO Glomerular Diseases 2021", tag:"Proteinuria Staging",
        formula:"UPCR (mg/g) = [U Protein / U Creatinine] × 100",
        note:"Nephrotic-range: UPCR ≥3500 mg/g (≥3.5 g/24h).",
        inputs:[
          {id:"u_prot",label:"Urine Total Protein",unit:"mg/dL",type:"number",ph:"350"},
          {id:"u_cr",label:"Urine Creatinine",unit:"mg/dL",type:"number",ph:"100"},
        ],
        compute(v){
          const up=+v.u_prot, uc=+v.u_cr;
          if(!up||!uc||uc<=0) return null;
          return {val:((up/uc)*100).toFixed(0),unit:"mg/g",sec:`~${((up/uc)*100/1000).toFixed(2)} g/day`};
        },
        interpret(r){
          const v=+r.val;
          if(v<150) return {c:"#16a34a",t:`UPCR ${r.val} — Normal (<150). ${GUIDELINE_CLOSING}`};
          if(v<1000) return {c:"#ca8a04",t:`UPCR ${r.val} — Significant proteinuria. RAAS blockade and SGLT2i consideration recommended. ${GUIDELINE_CLOSING}`};
          if(v<3500) return {c:"#ea580c",t:`UPCR ${r.val} — Heavy sub-nephrotic proteinuria. Nephrology referral. Consider biopsy. ${GUIDELINE_CLOSING}`};
          return {c:"#dc2626",t:`UPCR ${r.val} — Nephrotic-range (>=3500). Renal biopsy strongly recommended. ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"selectivity", name:"Selectivity Index", ref:"Cameron & Blandford, Lancet 1966", tag:"Selective vs Non-Selective",
        formula:"SI = (UIgG/PIgG) / (UTransferrin/PTransferrin)\n<0.1 selective (MCD). >0.2 non-selective",
        note:"Retains utility in paediatric nephrotic syndrome.",
        inputs:[
          {id:"uigg",label:"Urine IgG",unit:"mg/dL",type:"number",ph:"5"},
          {id:"pigg",label:"Plasma IgG",unit:"mg/dL",type:"number",ph:"1200"},
          {id:"utf",label:"Urine Transferrin",unit:"mg/dL",type:"number",ph:"30"},
          {id:"ptf",label:"Plasma Transferrin",unit:"mg/dL",type:"number",ph:"250"},
        ],
        compute(v){
          const ui=+v.uigg,pi=+v.pigg,ut=+v.utf,pt=+v.ptf;
          if(!ui||!pi||!ut||!pt||pi<=0||pt<=0) return null;
          return {val:((ui/pi)/(ut/pt)).toFixed(3),unit:"ratio"};
        },
        interpret(r){
          const v=+r.val;
          if(v<0.1) return {c:"#16a34a",t:`SI ${r.val} — Highly selective. Favours MCD. Strong steroid response expected. ${GUIDELINE_CLOSING}`};
          if(v<0.2) return {c:"#ca8a04",t:`SI ${r.val} — Intermediate. MCD or early FSGS. Biopsy indicated in adults. ${GUIDELINE_CLOSING}`};
          return {c:"#dc2626",t:`SI ${r.val} — Non-selective. Favours FSGS, membranous, or secondary GN. Biopsy indicated. ${GUIDELINE_CLOSING}`};
        }
      },
    ]
  },

  // ─────────────────────────────────────────
  // IX. RAAS & HYPERTENSION,
  // ─────────────────────────────────────────
  {
    id:"s9", label:"RAAS & Hypertension",
    calcs:[
      {
        id:"arr", name:"Aldosterone-Renin Ratio (ARR)", ref:"Funder et al., JCEM 2016", tag:"Primary Aldosteronism Screen",
        formula:"ARR = PAC (ng/dL) / PRA (ng/mL/h)\nPositive: ARR >=20 AND PAC >=15 ng/dL",
        note:"Collect off spironolactone >=6 weeks. Normalise K+ first.",
        inputs:[
          {id:"aldo",label:"Plasma Aldosterone (PAC)",unit:"ng/dL",type:"number",ph:"18"},
          {id:"pra",label:"Plasma Renin Activity (PRA)",unit:"ng/mL/h",type:"number",ph:"0.45"},
        ],
        compute(v){
          const a=+v.aldo,p=+v.pra;
          if(!a||!p||p<=0) return null;
          return {val:(a/p).toFixed(1),unit:"ARR",sec:`PAC: ${a} ng/dL | PRA: ${p} ng/mL/h`};
        },
        interpret(r,v){
          const arr=+r.val,aldo=+v.aldo;
          if(arr>=20&&aldo>=15) return {c:"#dc2626",t:`ARR ${r.val} with PAC ${aldo} — Positive screen. Confirmatory testing indicated (oral sodium loading or IV saline infusion). ${GUIDELINE_CLOSING}`};
          if(arr>=20) return {c:"#ca8a04",t:`ARR ${r.val} — Ratio elevated but PAC ${aldo} below 15. Borderline. Low PRA can artefactually elevate ARR. ${GUIDELINE_CLOSING}`};
          return {c:"#16a34a",t:`ARR ${r.val} — Negative screen. Primary aldosteronism less likely. ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"renin_pheno", name:"[REF] Renin Phenotype & Drug Selection", ref:"Williams et al., BMJ 2004; Laragh, Am J Med 1978", tag:"PRA-Guided Therapy",
        formula:"Low Renin: PRA <0.65 -> V-drugs (Volume)\nHigh Renin: PRA >=0.65 -> R-drugs (RAAS)",
        note:"REFERENCE PANEL — This is not a validated scoring tool. Published guideline criteria are presented for clinical reference only. Interpretation requires independent clinical judgement.\n\nPRA-guided drug selection pairs well with the ABCD treatment rule.",
        inputs:[],
        compute(){ return {val:"Reference Panel",unit:"See guideline criteria above"}; },
        interpret(){ return {c:"#6366f1",t:`This is a reference panel summarising published guideline criteria. No composite score is computed. Apply these criteria using independent clinical judgement within your institutional protocols. ${GUIDELINE_CLOSING}`}; }
      },
      {
        id:"res_htn", name:"Resistant Hypertension", ref:"Carey et al., Hypertension 2018", tag:"Resistant HTN",
        formula:"BP >target AND >=3 drugs at optimal doses AND includes diuretic",
        note:"GUIDELINE-BASED TOOL — This calculator applies published clinical thresholds but is not itself a validated composite scoring instrument. Interpret within clinical context.\n\nConfirm true resistance: adherence verified, white-coat excluded, secondary causes screened.",
        inputs:[
          {id:"bp_target",label:"BP above target despite treatment",type:"checkbox"},
          {id:"drugs3",label:"On >=3 drug classes at optimal doses",type:"checkbox"},
          {id:"diuretic",label:"Regimen includes a diuretic",type:"checkbox"},
          {id:"adherence",label:"Adherence confirmed",type:"checkbox"},
          {id:"secondary",label:"Secondary causes excluded",type:"checkbox"},
        ],
        compute(v){
          const poss=v.bp_target&&v.drugs3&&v.diuretic;
          const confirmed=poss&&v.adherence&&v.secondary;
          return {val:confirmed?"TRUE RESISTANT HTN":poss?"POSSIBLE (UNCONFIRMED)":"DOES NOT MEET CRITERIA",unit:""};
        },
        interpret(r){
          if(r.val==="TRUE RESISTANT HTN") return {c:"#dc2626",t:`True resistant HTN confirmed. Consider spironolactone as 4th agent. RDN eligibility assessment if eGFR >40. ${GUIDELINE_CLOSING}`};
          if(r.val.includes("UNCONFIRMED")) return {c:"#ca8a04",t:`Possibly resistant. Confirm adherence, perform ABPM, screen secondary causes before labelling. ${GUIDELINE_CLOSING}`};
          return {c:"#16a34a",t:`Does not meet resistant HTN criteria. Optimise current regimen. ${GUIDELINE_CLOSING}`};
        }
      },
    ]
  },

  // ─────────────────────────────────────────
  // X. CARDIORENAL SYNDROME,
  // ─────────────────────────────────────────
  {
    id:"s10", label:"Cardiorenal Syndrome",
    calcs:[
      {
        id:"crs1", name:"[REF] CRS Type 1 (Acute HF -> AKI)", ref:"Ronco et al., JACC 2008", tag:"Acute CRS",
        formula:"Renal Perfusion Pressure = MAP - CVP",
        note:"REFERENCE PANEL — This is not a validated scoring tool. Published guideline criteria are presented for clinical reference only. Interpretation requires independent clinical judgement.\n\nVenous congestion contributes to AKI as much as reduced cardiac output.",
        inputs:[],
        compute(){ return {val:"Reference Panel",unit:"See guideline criteria above"}; },
        interpret(){ return {c:"#6366f1",t:`This is a reference panel summarising published guideline criteria. No composite score is computed. Apply these criteria using independent clinical judgement within your institutional protocols. ${GUIDELINE_CLOSING}`}; }
      },
      {
        id:"fena_cardio", name:"FENa in Cardiorenal", ref:"Mullens et al., JACC 2009", tag:"FENa in Volume Overload",
        formula:"FENa <1% with volume overload = effective arterial underfilling",
        note:"GUIDELINE-BASED TOOL — This calculator applies published clinical thresholds but is not itself a validated composite scoring instrument. Interpret within clinical context.\n\nParadox of CRS: FENa <1% despite fluid overload. Low EABV triggers avid Na retention.",
        inputs:[
          {id:"una",label:"Urine Sodium",unit:"mEq/L",type:"number",ph:"12"},
          {id:"pna",label:"Plasma Sodium",unit:"mEq/L",type:"number",ph:"140"},
          {id:"ucr",label:"Urine Creatinine",unit:"mg/dL",type:"number",ph:"60"},
          {id:"pcr",label:"Plasma Creatinine",unit:"mg/dL",type:"number",ph:"2.5"},
          {id:"vol",label:"Volume status",type:"select",options:["Volume overloaded","Volume deplete","Euvolaemic"]},
        ],
        compute(v){
          const un=+v.una,pn=+v.pna,uc=+v.ucr,pc=+v.pcr;
          if(!un||!pn||!uc||!pc||pn<=0||uc<=0) return null;
          return {val:((un/pn)/(uc/pc)*100).toFixed(2),unit:"%"};
        },
        interpret(r,v){
          const fena=+r.val;
          if(fena<1&&v.vol==="Volume overloaded") return {c:"#dc2626",t:`FENa ${r.val}% with overload — Classic CRS. Avid Na retention despite fluid excess. Optimise CO, aggressive diuresis or UF. ${GUIDELINE_CLOSING}`};
          if(fena<1) return {c:"#ca8a04",t:`FENa ${r.val}% — Pre-renal. Address effective circulating volume. ${GUIDELINE_CLOSING}`};
          return {c:"#ea580c",t:`FENa ${r.val}% (>=1%) — Intrinsic component. Review for concurrent ATN. ${GUIDELINE_CLOSING}`};
        }
      },
    ]
  },

  // ─────────────────────────────────────────
  // XI. GLOMERULAR DISEASES,
  // ─────────────────────────────────────────
  {
    id:"s11", label:"Glomerular Diseases",
    calcs:[
      {
        id:"anti_gbm", name:"[REF] Anti-GBM Disease", ref:"Pusey CD, Kidney Int 2003", tag:"Goodpasture / Anti-GBM",
        formula:"Anti-GBM titre positive + RPGN +/- pulmonary haemorrhage",
        note:"REFERENCE PANEL — This is not a validated scoring tool. Published guideline criteria are presented for clinical reference only. Interpretation requires independent clinical judgement.\n\nMEDICAL EMERGENCY. Treat without awaiting biopsy if clinical picture clear.",
        inputs:[],
        compute(){ return {val:"Reference Panel",unit:"See guideline criteria above"}; },
        interpret(){ return {c:"#6366f1",t:`This is a reference panel summarising published guideline criteria. No composite score is computed. Apply these criteria using independent clinical judgement within your institutional protocols. ${GUIDELINE_CLOSING}`}; }
      },
      {
        id:"anca", name:"[REF] ANCA-Associated Vasculitis", ref:"Jennette et al., Arthritis Rheum 2013", tag:"AAV — GPA/MPA",
        formula:"ANCA (PR3 or MPO) positive + RPGN or systemic vasculitis",
        note:"REFERENCE PANEL — This is not a validated scoring tool. Published guideline criteria are presented for clinical reference only. Interpretation requires independent clinical judgement.\n\nRPGN is a nephrology emergency requiring same-day evaluation.",
        inputs:[],
        compute(){ return {val:"Reference Panel",unit:"See guideline criteria above"}; },
        interpret(){ return {c:"#6366f1",t:`This is a reference panel summarising published guideline criteria. No composite score is computed. Apply these criteria using independent clinical judgement within your institutional protocols. ${GUIDELINE_CLOSING}`}; }
      },
      {
        id:"complement_act", name:"[REF] Complement Pattern", ref:"Sethi & Fervenza, NEJM 2012", tag:"C3/C4 Differentiation",
        formula:"C3 Low + C4 Low = Classical (SLE, IC-MPGN)\nC3 Low + C4 Normal = Alternative (C3G, PSGN, aHUS)",
        note:"REFERENCE PANEL — This is not a validated scoring tool. Published guideline criteria are presented for clinical reference only. Interpretation requires independent clinical judgement.\n\nEssential in GN workup. Pattern narrows differential before biopsy.",
        inputs:[],
        compute(){ return {val:"Reference Panel",unit:"See guideline criteria above"}; },
        interpret(){ return {c:"#6366f1",t:`This is a reference panel summarising published guideline criteria. No composite score is computed. Apply these criteria using independent clinical judgement within your institutional protocols. ${GUIDELINE_CLOSING}`}; }
      },
    ]
  },

  // ─────────────────────────────────────────
  // XII. VASCULAR NEPHROLOGY,
  // ─────────────────────────────────────────
  {
    id:"s12", label:"Vascular Nephrology",
    calcs:[
    ]
  },

  // ─────────────────────────────────────────
  // XIII. HAEMATOLOGIC — TMA,
  // ─────────────────────────────────────────
  {
    id:"s13", label:"Haematologic — TMA",
    calcs:[
      {
        id:"tma", name:"[REF] TMA Diagnostic Pattern", ref:"George JN, NEJM 2006", tag:"Thrombotic Microangiopathy",
        formula:"TMA = AKI + MAHA (schistocytes + neg Coombs) + Thrombocytopenia + Elevated LDH",
        note:"REFERENCE PANEL — This is not a validated scoring tool. Published guideline criteria are presented for clinical reference only. Interpretation requires independent clinical judgement.\n\nADAMTS13 is the key test differentiating TTP from other TMAs.",
        inputs:[],
        compute(){ return {val:"Reference Panel",unit:"See guideline criteria above"}; },
        interpret(){ return {c:"#6366f1",t:`This is a reference panel summarising published guideline criteria. No composite score is computed. Apply these criteria using independent clinical judgement within your institutional protocols. ${GUIDELINE_CLOSING}`}; }
      },
      {
        id:"adamts13", name:"ADAMTS13 Interpretation", ref:"Sadler JE, NEJM 2004", tag:"TTP vs aHUS",
        formula:"<10% = TTP | 10-50% = Indeterminate | >50% = TTP excluded",
        note:"GUIDELINE-BASED TOOL — This calculator applies published clinical thresholds but is not itself a validated composite scoring instrument. Interpret within clinical context.\n\nADAMTS13 cleaves ultra-large VWF multimers. Can be depleted in sepsis — interpret cautiously.",
        inputs:[
          {id:"adamts13",label:"ADAMTS13 Activity",unit:"%",type:"number",ph:"8"},
          {id:"inhibitor",label:"Anti-ADAMTS13 antibody positive",type:"checkbox"},
        ],
        compute(v){
          const a=+v.adamts13; if(!a&&a!==0) return null;
          const cat=a<10?"TTP":a<=50?"Indeterminate":"TTP Excluded";
          return {val:cat,unit:`ADAMTS13: ${a}%`};
        },
        interpret(r,v){
          const a=+v.adamts13;
          if(a<10) return {c:"#dc2626",t:`ADAMTS13 ${a}% — TTP. ${v.inhibitor?"Acquired (antibody+)":"Congenital if antibody-"}. Plasma exchange + steroids + rituximab. Caplacizumab if available. ${GUIDELINE_CLOSING}`};
          if(a<=50) return {c:"#ca8a04",t:`ADAMTS13 ${a}% — Indeterminate. Not classic TTP. Clinical judgement. ${GUIDELINE_CLOSING}`};
          return {c:"#16a34a",t:`ADAMTS13 ${a}% — TTP excluded. Consider: aHUS (eculizumab), STEC-HUS (supportive), drug-induced, HELLP. ${GUIDELINE_CLOSING}`};
        }
      },
    ]
  },

  // ─────────────────────────────────────────
  // XIV. OBSTETRIC NEPHROLOGY,
  // ─────────────────────────────────────────
  {
    id:"s14", label:"Obstetric Nephrology",
    calcs:[
      {
        id:"pe_upcr", name:"Preeclampsia Proteinuria", ref:"ACOG Practice Bulletin 222, 2020", tag:"Proteinuria in Pregnancy",
        formula:"UPCR >=0.3 mg/mg = significant proteinuria in pregnancy",
        note:"GUIDELINE-BASED TOOL — This calculator applies published clinical thresholds but is not itself a validated composite scoring instrument. Interpret within clinical context.\n\nRequires new-onset HTN >=140/90 after 20 weeks for preeclampsia diagnosis.",
        inputs:[
          {id:"upcr",label:"Spot Urine PCR",unit:"mg/mg",type:"number",ph:"0.45"},
          {id:"sbp",label:"Systolic BP",unit:"mmHg",type:"number",ph:"150"},
          {id:"dbp",label:"Diastolic BP",unit:"mmHg",type:"number",ph:"98"},
          {id:"ga",label:"Gestational Age",unit:"weeks",type:"number",ph:"32"},
        ],
        compute(v){
          const upcr=+v.upcr,ga=+v.ga; if(!upcr||!ga) return null;
          return {val:upcr.toFixed(2),unit:"mg/mg UPCR"};
        },
        interpret(r,v){
          const upcr=+r.val,sbp=+v.sbp,dbp=+v.dbp,ga=+v.ga;
          const htn=sbp>=140||dbp>=90;
          if(upcr>=0.3&&htn) return {c:"#dc2626",t:`UPCR ${r.val} with HTN at ${ga}wk — Preeclampsia criteria met. MFM referral. Antihypertensives. Foetal surveillance. ${GUIDELINE_CLOSING}`};
          if(upcr>=0.3) return {c:"#ca8a04",t:`UPCR ${r.val} — Significant proteinuria at ${ga}wk without HTN yet. Monitor closely. ${GUIDELINE_CLOSING}`};
          return {c:"#16a34a",t:`UPCR ${r.val} — Below threshold. Routine monitoring. ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"sflt_plgf", name:"sFlt-1/PlGF Ratio", ref:"Verlohren et al., Am J Obstet Gynecol 2012", tag:"Preeclampsia Prediction",
        formula:"<38 = low risk (rule out) | >85 (20-34wk) or >110 (>34wk) = high risk",
        note:"Ratio <38 has 99% NPV for preeclampsia within 1 week (PROGNOSIS trial).",
        inputs:[
          {id:"sflt",label:"sFlt-1",unit:"pg/mL",type:"number",ph:"5200"},
          {id:"plgf",label:"PlGF",unit:"pg/mL",type:"number",ph:"45"},
          {id:"ga",label:"Gestational Age",unit:"weeks",type:"number",ph:"30"},
        ],
        compute(v){
          const s=+v.sflt,p=+v.plgf,g=+v.ga;
          if(!s||!p||!g||p<=0) return null;
          return {val:(s/p).toFixed(1),unit:"sFlt-1/PlGF ratio"};
        },
        interpret(r,v){
          const ratio=+r.val,ga=+v.ga;
          const threshold=ga<=34?85:110;
          if(ratio<38) return {c:"#16a34a",t:`Ratio ${r.val} (<38) — LOW RISK. Preeclampsia ruled out for 1 week (NPV 99%). ${GUIDELINE_CLOSING}`};
          if(ratio<threshold) return {c:"#ca8a04",t:`Ratio ${r.val} — Intermediate. Increased surveillance. MFM review. ${GUIDELINE_CLOSING}`};
          return {c:"#dc2626",t:`Ratio ${r.val} (>=${threshold}) — HIGH RISK. Preeclampsia imminent. Urgent MFM/obstetric review. ${GUIDELINE_CLOSING}`};
        }
      },
    ]
  },

  // ─────────────────────────────────────────
  // XV. RCC & ONCOLOGY,
  // ─────────────────────────────────────────
  {
    id:"s15", label:"RCC & Oncology",
    calcs:[
      {
        id:"imdc", name:"IMDC Criteria (Heng)", ref:"Heng et al., Lancet Oncol 2009", tag:"mRCC Prognosis",
        formula:"0 = Favourable | 1-2 = Intermediate | >=3 = Poor",
        note:"Validated in targeted therapy era. Guides immunotherapy selection.",
        inputs:[
          {id:"kps",label:"KPS <80%",type:"checkbox"},
          {id:"time1yr",label:"Dx to systemic Tx <1 year",type:"checkbox"},
          {id:"hb_low",label:"Hb below LLN",type:"checkbox"},
          {id:"ca_high",label:"Corrected Ca above ULN",type:"checkbox"},
          {id:"neut",label:"Neutrophils above ULN",type:"checkbox"},
          {id:"plt",label:"Platelets above ULN",type:"checkbox"},
        ],
        compute(v){
          return {val:[v.kps,v.time1yr,v.hb_low,v.ca_high,v.neut,v.plt].filter(Boolean).length,unit:"risk factors"};
        },
        interpret(r){
          const v=r.val;
          if(v===0) return {c:"#16a34a",t:`${v} factors — Favourable. Median OS ~43mo. IO combinations or sunitinib. ${GUIDELINE_CLOSING}`};
          if(v<=2) return {c:"#ca8a04",t:`${v} factor(s) — Intermediate. Median OS ~23mo. Nivo+ipi or pembro+axi. ${GUIDELINE_CLOSING}`};
          return {c:"#dc2626",t:`${v} factors — Poor. Median OS ~8mo. Nivo+ipi or cabo+nivo. Early palliative care. ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"renal_neph", name:"RENAL Nephrometry Score", ref:"Kutikov & Uzzo, J Urol 2009", tag:"Surgical Complexity",
        formula:"Score = R + E + N + A + L\nLow 4-6 | Moderate 7-9 | High 10-12",
        note:"Guides partial vs radical nephrectomy decision.",
        inputs:[
          {id:"r",label:"R (Radius)",type:"select",options:["<=4cm (1)","4-7cm (2)",">7cm (3)"]},
          {id:"e",label:"E (Exophytic)",type:"select",options:[">=50% (1)","<50% (2)","Endophytic (3)"]},
          {id:"n",label:"N (Nearness to sinus)",type:"select",options:[">=7mm (1)","4-6mm (2)","<4mm (3)"]},
          {id:"l",label:"L (Location)",type:"select",options:["Above/below polar (1)","Crosses polar (2)","Between polar (3)"]},
        ],
        compute(v){
          const pts=s=>parseInt(s.match(/\((\d+)\)/)?.[1]||"0");
          return {val:[v.r,v.e,v.n,v.l].reduce((a,x)=>a+pts(x),0),unit:"points"};
        },
        interpret(r){
          const v=r.val;
          if(v<=6) return {c:"#16a34a",t:`RENAL ${v} — Low complexity. Partial nephrectomy preferred and feasible. ${GUIDELINE_CLOSING}`};
          if(v<=9) return {c:"#ca8a04",t:`RENAL ${v} — Moderate complexity. Partial may be feasible with experienced surgeon. ${GUIDELINE_CLOSING}`};
          return {c:"#dc2626",t:`RENAL ${v} — High complexity. Radical nephrectomy often required. ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"stone", name:"STONE Score", ref:"Moore et al., Ann Emerg Med 2014", tag:"Ureteral Stone Probability",
        formula:"Score = Sex + Timing + Origin + Nausea + Erythrocytes",
        note:"Predicts ureteral stone probability before CT KUB.",
        inputs:[
          {id:"sex",label:"Sex",type:"select",options:["Female (0)","Male (3)"]},
          {id:"timing",label:"Sudden onset",type:"select",options:["No (0)","Yes (3)"]},
          {id:"origin",label:"Flank/groin pain",type:"select",options:["No (0)","Yes (3)"]},
          {id:"nausea",label:"Nausea/vomiting",type:"select",options:["No (0)","Yes (1)"]},
          {id:"eryth",label:"Haematuria",type:"select",options:["No (0)","Yes (3)"]},
        ],
        compute(v){
          const pts=s=>parseInt(s.match(/\((\d+)\)/)?.[1]||"0");
          return {val:[v.sex,v.timing,v.origin,v.nausea,v.eryth].reduce((a,x)=>a+pts(x),0),unit:"points"};
        },
        interpret(r){
          const v=r.val;
          if(v<=5) return {c:"#16a34a",t:`Score ${v} — Low probability (~9%). Consider alternatives. ${GUIDELINE_CLOSING}`};
          if(v<=9) return {c:"#ca8a04",t:`Score ${v} — Moderate (~51%). CT KUB recommended. ${GUIDELINE_CLOSING}`};
          return {c:"#dc2626",t:`Score ${v} — High (~89%). CT KUB. Urology if >5mm, obstruction, or fever. ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"irae_renal", name:"irAE Renal Toxicity — Nephritis (ASCO 2018)", ref:"Brahmer JR, Lacchetti C, Schneider BJ et al., JCO 2018;36(17):1714-1768 (ASCO Guideline §6.0-6.2)", tag:"Immune Checkpoint Inhibitor Nephrotoxicity",
        formula:"ASCO §6.1 Nephritis Grading (Expert Consensus):\n  G1: Creatinine level increase of >0.3 mg/dL; creatinine 1.5–2.0× over baseline\n  G2: Creatinine 2–3× above baseline\n  G3: Creatinine >3× baseline or >4.0 mg/dL; hospitalisation indicated\n  G4: Life-threatening consequences; dialysis indicated",
        note:"§6.0 Diagnosis & Monitoring: Monitor Cr prior to every dose. Routine urinalysis is not necessary other than to rule out UTIs. If no potential alternative cause of AKI identified, forego biopsy and proceed directly with immunosuppressive therapy — swift treatment of the autoimmune component is important. Reflex kidney biopsy should be DISCOURAGED until corticosteroid treatment has been attempted.\n\n§6.1 Management:\n  G1 — Consider temporarily holding ICPi pending evaluation of alternative aetiologies (recent IV contrast, medications, fluid status). A change still <1.5× ULN could be meaningful.\n  G2 — Hold ICPi temporarily. Nephrology consult. Rule out other causes; if excluded, prednisone 0.5–1 mg/kg/d. If worsening or no improvement: 1–2 mg/kg/d and permanently discontinue. If improved to ≤G1, taper steroids over 4–6 weeks. Discuss resumption with patient (risks vs benefits).\n  G3 — Permanently discontinue ICPi. Nephrology consult. Steroids 1–2 mg/kg/d. Monitor Cr weekly.\n  G4 — As G3 + urgent dialysis.\n\n§6.2 Follow-up:\n  G1 — If improved to baseline, resume routine monitoring.\n  G2 — Taper steroids over ≥3 weeks; if persistent >7 days, treat as G3.\n  G3 — Taper over ≥4 weeks; if persistent >3–5 days, consider mycophenolate.\n  G4 — Taper over ≥4 weeks; if persistent >2–3 days, consider mycophenolate.\n\nAll recommendations are expert consensus based, with benefits outweighing harms.",
        inputs:[
          {id:"cr_base",label:"Baseline Creatinine",unit:"mg/dL",type:"number",ph:"0.9"},
          {id:"cr_now",label:"Current Creatinine",unit:"mg/dL",type:"number",ph:"2.4"},
        ],
        compute(v){
          const base=+v.cr_base, now=+v.cr_now;
          if(!base||!now||base<=0) return null;
          const ratio=now/base, rise=now-base;
          let grade=0;
          if(now>4.0||ratio>3.0) grade=3;
          if(ratio>=2.0&&grade<3) grade=2;
          if((ratio>=1.5||rise>0.3)&&grade<2) grade=1;
          return {val:"Grade "+grade,unit:"(Cr "+ratio.toFixed(2)+"× baseline; rise "+rise.toFixed(2)+" mg/dL)"};
        },
        interpret(r,v){
          const base=+v.cr_base, now=+v.cr_now;
          const ratio=now/base, rise=now-base;
          if(now>4.0||ratio>3.0) return {c:"#dc2626",t:`GRADE 3 — Creatinine ${ratio.toFixed(1)}× baseline${now>4.0?" (>4.0 mg/dL)":""}. Hospitalisation indicated. PERMANENTLY DISCONTINUE ICPi. Nephrology consult. Evaluate for other causes (IV contrast, medications, fluid status). Corticosteroids 1–2 mg/kg/d prednisone equivalent. Reflex biopsy discouraged until steroids attempted. Monitor Cr weekly. If improved to ≤G1, taper over ≥4 weeks. If persistent >3–5 days or worsening, consider mycophenolate. Note: also evaluate for G4 if dialysis is indicated. ${GUIDELINE_CLOSING}`};
          if(ratio>=2.0) return {c:"#ea580c",t:`GRADE 2 — Creatinine ${ratio.toFixed(1)}× baseline. HOLD ICPi temporarily. Nephrology consult. Evaluate for other causes (IV contrast, medications, fluid status). If other aetiologies ruled out: prednisone 0.5–1 mg/kg/d. If worsening or no improvement: escalate to 1–2 mg/kg/d and permanently discontinue ICPi. If improved to ≤G1, taper steroids over 4–6 weeks. If no recurrence, discuss resumption with patient (risks vs benefits). If persistent >7 days or worsening, treat as G3. ${GUIDELINE_CLOSING}`};
          if(ratio>=1.5||rise>0.3) return {c:"#ca8a04",t:`GRADE 1 — Creatinine ${ratio.toFixed(2)}× baseline (rise ${rise.toFixed(2)} mg/dL). Consider temporarily holding ICPi pending evaluation of alternative aetiologies (recent IV contrast, medications, fluid status, baseline renal function). Note: a change still <1.5× ULN could be meaningful. If improved to baseline, resume routine creatinine monitoring. ${GUIDELINE_CLOSING}`};
          return {c:"#16a34a",t:`No significant creatinine rise (${ratio.toFixed(2)}× baseline). Continue ICPi with routine monitoring — check creatinine prior to every dose per ASCO §6.0. ${GUIDELINE_CLOSING}`};
        }
      },

      {
        id:"cp_aki", name:"Cisplatin-Associated AKI (CP-AKI) Risk Calculator", ref:"Gupta S, Glezerman IG, Hirsch JS et al., BMJ 2024;384:e077169; n=24717; C-statistic 0.75", tag:"Cisplatin Nephrotoxicity — Validated Risk Prediction",
        formula:"Risk % = 100 / (1 + e^(−x)), where x = −3.686659 + f(Age) − f(Mg) − f(Hgb) + f(WBC) − f(Alb) + f(Cisplatin) + f(Plt) − f(SCr) + 0.2739952×HTN + 0.2528551×DM\n\nEach continuous variable uses restricted cubic splines (RCS). Full coefficients published in the BMJ supplement.\n\nCP-AKI defined as: ≥2-fold rise in serum creatinine OR kidney replacement therapy within 14 days of first IV cisplatin dose.",
        note:"Use the most recent lab values obtained prior to receiving cisplatin. Validated across 6 US academic cancer centres (n=24,717; derivation 11,766, validation 12,951). CP-AKI incidence: 5.2% (derivation), 3.3% (validation). C-statistic 0.75 — superior to all prior models (C 0.60–0.68). Stage 3 CP-AKI associated with 4.63× hazard of 90-day mortality. Unit conversions: Scr input in µmol/L → converted to mg/dL (÷88.4); Alb input in g/L → g/dL (÷10); Mg input in mmol/L → mg/dL (×2.43); Hgb input in g/L → g/dL (÷10).",
        inputs:[
          {id:"age",label:"Age",unit:"years",type:"number",ph:"62"},
          {id:"htn",label:"History of hypertension",type:"select",options:["No","Yes"]},
          {id:"dm",label:"History of diabetes mellitus",type:"select",options:["No","Yes"]},
          {id:"dose",label:"Cisplatin dose",unit:"mg",type:"number",ph:"140"},
          {id:"scr",label:"Serum creatinine",unit:"µmol/L",type:"number",ph:"85"},
          {id:"alb",label:"Albumin",unit:"g/L",type:"number",ph:"38"},
          {id:"mg_val",label:"Magnesium",unit:"mmol/L",type:"number",ph:"0.82"},
          {id:"hgb",label:"Haemoglobin",unit:"g/L",type:"number",ph:"125"},
          {id:"wbc",label:"White blood cell count",unit:"× 10⁹ cells/L",type:"number",ph:"7.5"},
          {id:"plt",label:"Platelet count",unit:"× 10⁹/L",type:"number",ph:"250"},
        ],
        compute(v){
          const age=+v.age, dose=+v.dose, scrSI=+v.scr, albSI=+v.alb, mgSI=+v.mg_val, hgbSI=+v.hgb, wbcRaw=+v.wbc, pltRaw=+v.plt;
          if(!age||!dose||!scrSI||!albSI||!mgSI||!hgbSI||!wbcRaw||!pltRaw) return null;
          const htn=v.htn==="Yes"?1:0, dm=v.dm==="Yes"?1:0;
          /* Convert SI → model units (mg/dL, g/dL, ×10³/µL) */
          const scr=scrSI/88.4;   /* µmol/L → mg/dL */
          const alb=albSI/10;     /* g/L → g/dL */
          const mg=mgSI*2.43;     /* mmol/L → mg/dL */
          const hgb=hgbSI/10;     /* g/L → g/dL */
          const wbc=wbcRaw;       /* ×10⁹/L = ×10³/µL */
          const plt=pltRaw;       /* ×10⁹/L = ×10³/µL */
          /* Helper: (val - knot)+ ^3 */
          const p3=(val,knot)=>{const d=val-knot; return d>0?d*d*d:0;};
          /* Age RCS */
          const fAge=0.04421425*age+0.0000183485*p3(age,30)-0.0002163227*p3(age,51)+0.0004394909*p3(age,59)-0.0002907307*p3(age,66)+0.0000492141*p3(age,76);
          /* Magnesium RCS (subtract) */
          const fMg=0.2525115*mg-5.801969*p3(mg,1.7)+29.89521*p3(mg,1.9456)-43.75054*p3(mg,2.1)+18.23788*p3(mg,2.2)+1.419414*p3(mg,2.432);
          /* Hemoglobin RCS (subtract) */
          const fHgb=0.04471118*hgb-0.009984642*p3(hgb,9.1)+0.07499566*p3(hgb,11.6)-0.1355953*p3(hgb,12.8)+0.08595369*p3(hgb,13.9)-0.01536942*p3(hgb,15.5);
          /* WBC RCS (add) */
          const fWbc=0.01993736*wbc-0.003237126*p3(wbc,3.8)+0.02176998*p3(wbc,5.8)-0.03178413*p3(wbc,7.1)+0.01411246*p3(wbc,8.8)-0.0008611787*p3(wbc,14.5);
          /* Albumin RCS (subtract) */
          const fAlb=0.4990617*alb-0.02681548*p3(alb,3)+4.312953*p3(alb,3.8)-13.50495*p3(alb,4.1)+10.66724*p3(alb,4.3)-1.448432*p3(alb,4.7);
          /* Cisplatin dose RCS (add) */
          const fCis=0.04708185*dose-0.00001028397*p3(dose,38)+0.00002391644*p3(dose,65)-0.00001521614*p3(dose,90)+0.000002039042*p3(dose,150)-0.0000004553695*p3(dose,220);
          /* Platelet RCS (add) */
          const fPlt=0.00397566*plt-0.0000005145004*p3(plt,137)+0.00000222745*p3(plt,210)-0.000002459005*p3(plt,255)+0.0000007631055*p3(plt,312)-0.00000001705063*p3(plt,488);
          /* Baseline SCr RCS (subtract) */
          const fScr=4.626802*scr+94.00696*p3(scr,0.6)-187.9561*p3(scr,0.7)+232.7567*p3(scr,0.9)-153.7796*p3(scr,1.0)+14.97206*p3(scr,1.3);
          const x=-3.686659+fAge-fMg-fHgb+fWbc-fAlb+fCis+fPlt-fScr+0.2739952*htn+0.2528551*dm;
          const risk=100/(1+Math.exp(-x));
          return {val:risk.toFixed(1),unit:"% risk of CP-AKI",sec:`Scr ${scr.toFixed(2)} mg/dL | Alb ${alb.toFixed(1)} g/dL | Mg ${mg.toFixed(2)} mg/dL | Hgb ${hgb.toFixed(1)} g/dL | HTN:${htn} DM:${dm}`};
        },
        interpret(r,v){
          const risk=+r.val;
          if(risk<3) return {c:"#16a34a",t:`CP-AKI risk: ${r.val}% — LOW. Standard cisplatin hydration protocol (1–2L NS pre/post). IV Mg supplementation recommended. Monitor Scr days 3, 7, 14 after cisplatin. ${GUIDELINE_CLOSING}`};
          if(risk<8) return {c:"#ca8a04",t:`CP-AKI risk: ${r.val}% — MODERATE. Ensure aggressive hydration. IV Mg supplementation (8–16 mEq). Avoid concurrent nephrotoxins (NSAIDs, aminoglycosides). Monitor Scr closely (days 3, 7, 14). ${GUIDELINE_CLOSING}`};
          if(risk<15) return {c:"#ea580c",t:`CP-AKI risk: ${r.val}% — HIGH. Consider enhanced hydration. IV Mg mandatory. Minimise all concurrent nephrotoxins. Consider whether carboplatin substitution is oncologically appropriate. Close renal monitoring (Scr every 2–3 days for 14 days). Nephrology input recommended. ${GUIDELINE_CLOSING}`};
          return {c:"#dc2626",t:`CP-AKI risk: ${r.val}% — VERY HIGH. Strongly consider carboplatin substitution or dose reduction if oncologically feasible. If cisplatin essential: maximise hydration, IV Mg, strict nephrotoxin avoidance, daily Scr monitoring for 14 days. Pre-treatment nephrology consultation recommended. Stage 3 CP-AKI associated with 4.63× hazard of 90-day mortality (Gupta BMJ 2024). ${GUIDELINE_CLOSING}`};
        }
      },

    ]
  },

  // ─────────────────────────────────────────
  // XVI. SPECIALIST INDICES,
  // ─────────────────────────────────────────
  {
    id:"s16", label:"Specialist Indices",
    calcs:[
    ]
  },

  // ─────────────────────────────────────────
  // XVII. DIALYSIS & VASCULAR ACCESS,
  // ─────────────────────────────────────────
  {
    id:"s17", label: "Transplant Nephrology",
    calcs: [
      {
        id:"tx_cv_screen", name:"[REF] Cardiovascular Screening Trigger", ref:"KDIGO Transplant Candidacy 2020 §13.3; KDOQI Commentary 2021; ACC/AHA Perioperative Guidelines", tag:"Pre-Transplant CV Risk — Mandatory Workup Criteria",
        formula:"Mandatory pre-transplant cardiac workup triggered if ANY of:\n  • Diabetes mellitus (Type 1 or Type 2)\n  • Prior coronary artery disease (CAD)\n  • Functional capacity <4 METs\n  • Age ≥60 years (some centres ≥50)\n  • Peripheral vascular disease (PVD)\n  • Cerebrovascular disease (CVA/TIA)\n  • Current or former smoker (>10 pack-years)\n  • Heart failure (any NYHA class)\n  • ≥3 traditional cardiovascular risk factors",
        note:"REFERENCE PANEL — This is not a validated scoring tool. Published guideline criteria are presented for clinical reference only. Interpretation requires independent clinical judgement.\n\nKDIGO 2020 Statement 13.3 recommends cardiovascular evaluation of all transplant candidates. The extent of workup depends on risk factor burden. High-risk patients require non-invasive cardiac stress testing (exercise or pharmacological stress echocardiography, or myocardial perfusion imaging) and, if positive, coronary angiography. Low-risk patients may proceed with resting echocardiography and ECG alone. This calculator identifies whether mandatory extended cardiac workup is triggered.",
        inputs:[],
        compute(){ return {val:"Reference Panel",unit:"See guideline criteria above"}; },
        interpret(){ return {c:"#6366f1",t:`This is a reference panel summarising published guideline criteria. No composite score is computed. Apply these criteria using independent clinical judgement within your institutional protocols. ${GUIDELINE_CLOSING}`}; }
      },
      {
        id:"tx_malig_wait", name:"[REF] Malignancy Waiting Period Advisor", ref:"AST Consensus (Sawinski et al., Am J Transplant 2020); KDIGO 2020 §11; Israel Penn ITTR", tag:"Pre-Transplant Cancer Remission — Minimum Wait Before Listing",
        formula:"Minimum recommended waiting period from curative treatment to transplant listing:\n  No mandatory wait: Non-melanoma skin cancer (BCC/SCC), incidental renal mass ≤1cm, Gleason ≤6 prostate (low-risk), in situ cervical (CIN), superficial bladder (Ta low-grade)\n  2 years: Most solid organ tumours after curative resection (breast, colon, lung, etc.)\n  2 years: Haematological malignancies (lymphoma, leukaemia) after complete remission\n  5 years: Melanoma (stage I/II), invasive breast (stage II+), symptomatic RCC >T1\n  Case-by-case: Melanoma stage III+, mRCC, active haematological malignancy",
        note:"REFERENCE PANEL — This is not a validated scoring tool. Published guideline criteria are presented for clinical reference only. Interpretation requires independent clinical judgement.\n\nThe AST consensus (Sawinski et al., 2020) and KDIGO 2020 §11 provide evidence-based waiting period recommendations. The Israel Penn International Transplant Tumour Registry (ITTR) provides the largest dataset on post-transplant cancer recurrence. Key principle: immunosuppression accelerates recurrence of occult malignancy. These are minimum recommended wait times; individual assessment with oncology is essential. Some centres apply longer waiting periods for aggressive histologies.",
        inputs:[],
        compute(){ return {val:"Reference Panel",unit:"See guideline criteria above"}; },
        interpret(){ return {c:"#6366f1",t:`This is a reference panel summarising published guideline criteria. No composite score is computed. Apply these criteria using independent clinical judgement within your institutional protocols. ${GUIDELINE_CLOSING}`}; }
      },
      {
        id:"tx_bmi", name:"BMI & Obesity Candidacy Assessment", ref:"KDIGO Transplant Candidacy 2020 §6; KDOQI Commentary 2021", tag:"Pre-Transplant BMI — Listing Eligibility",
        formula:"BMI = Weight (kg) / Height (m)²\nKDIGO 2020 guidance:\n  BMI <18.5: Underweight — nutritional assessment\n  BMI 18.5–29.9: Generally acceptable for listing\n  BMI 30–34.9: Acceptable — lifestyle optimisation recommended\n  BMI 35–39.9: Strong consideration for weight reduction before listing\n  BMI ≥40: Most centres require weight reduction programme (bariatric/lifestyle) before listing",
        note:"GUIDELINE-BASED TOOL — This calculator applies published clinical thresholds but is not itself a validated composite scoring instrument. Interpret within clinical context.\n\nObesity increases perioperative risk (wound complications, delayed graft function, cardiovascular events) and reduces graft survival. KDIGO 2020 §6 recommends weight management for candidates with BMI ≥35 and strongly recommends it for BMI ≥40. There is no absolute BMI contraindication in KDIGO, but many transplant centres apply a BMI ≥40 (some ≥35) as a relative contraindication to listing until weight reduction is achieved. Underweight (BMI <18.5) warrants nutritional assessment as sarcopenia and frailty independently predict poor transplant outcomes.",
        inputs:[
          {id:"wt",label:"Weight",unit:"kg",type:"number",ph:"e.g. 95"},
          {id:"ht",label:"Height",unit:"cm",type:"number",ph:"e.g. 170"},
        ],
        compute(v){
          const wt=+v.wt, ht=+v.ht;
          if(!wt||!ht||wt<=0||ht<=0) return null;
          const htm = ht/100;
          const bmi = wt/(htm*htm);
          let cat = "";
          if(bmi<18.5) cat="Underweight";
          else if(bmi<25) cat="Normal weight";
          else if(bmi<30) cat="Overweight";
          else if(bmi<35) cat="Obese class I";
          else if(bmi<40) cat="Obese class II";
          else cat="Obese class III (morbid)";
          return {val:bmi.toFixed(1),unit:"kg/m²",sec:`Category: ${cat} | Wt: ${wt} kg | Ht: ${ht} cm`};
        },
        interpret(r){
          const bmi=+r.val;
          if(bmi<18.5) return {c:"#ca8a04",t:`BMI ${r.val} — Underweight. Nutritional assessment and dietetic input are recommended. Sarcopenia and frailty screening (Fried criteria) should be performed as both independently predict poor transplant outcomes. Investigate for malnutrition, chronic inflammation, or occult malignancy as appropriate. ${GUIDELINE_CLOSING}`};
          if(bmi<30) return {c:"#16a34a",t:`BMI ${r.val} — Within the generally acceptable range for transplant listing. Standard perioperative risk applies. Cardiovascular risk factor optimisation and maintenance of healthy weight are recommended. ${GUIDELINE_CLOSING}`};
          if(bmi<35) return {c:"#ca8a04",t:`BMI ${r.val} — Obese class I. Listing is generally acceptable at most centres, but lifestyle optimisation is recommended to reduce perioperative risk (wound complications, delayed graft function, cardiovascular events). Structured dietary counselling and exercise programme are advisable. ${GUIDELINE_CLOSING}`};
          if(bmi<40) return {c:"#ea580c",t:`BMI ${r.val} — Obese class II. Strong consideration for a supervised weight reduction programme before transplant listing is recommended. Some centres apply BMI ≥35 as a relative contraindication until weight loss is achieved. Bariatric surgery referral may be appropriate in selected patients. Perioperative risk is significantly increased. ${GUIDELINE_CLOSING}`};
          return {c:"#dc2626",t:`BMI ${r.val} — Obese class III. Most transplant centres require a supervised weight reduction programme or bariatric surgery before listing can proceed. Perioperative risk (wound infection, dehiscence, thromboembolism, delayed graft function, cardiovascular events) is substantially elevated. A structured multidisciplinary approach including bariatric medicine, dietetics, and exercise physiology is recommended. ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"tx_cpra", name:"HLA Sensitisation & cPRA Interpretation", ref:"KDIGO Transplant Candidacy 2020 §19; UNOS cPRA Definition", tag:"Pre-Transplant — Calculated Panel Reactive Antibody",
        formula:"Sensitisation categories based on cPRA:\n  <10% = Non-sensitised\n  10–79% = Moderately sensitised\n  80–97% = Highly sensitised\n  ≥98% = Very highly sensitised\ncPRA represents the % of donors against whom the patient has pre-formed anti-HLA antibodies",
        note:"cPRA (calculated Panel Reactive Antibody) is determined by solid-phase HLA antibody testing (Luminex single-antigen bead assay) and represents the percentage of the donor population to whom the candidate has unacceptable antigens. Higher cPRA = smaller compatible donor pool = longer expected waiting time. UNOS provides priority points for cPRA ≥98% candidates. Desensitisation protocols (IVIG, rituximab, plasmapheresis, imlifidase) may be considered for highly sensitised candidates in selected centres. KDIGO 2020 §19 recommends regular antibody monitoring (every 3 months while on waitlist and after sensitising events).",
        inputs:[
          {id:"cpra",label:"cPRA (Calculated Panel Reactive Antibody)",unit:"%",type:"number",ph:"e.g. 85"},
          {id:"sensitising",label:"Prior sensitising events",type:"select",options:[
            "None known",
            "Prior transplant(s)",
            "Blood transfusion(s)",
            "Pregnancy / pregnancies",
            "Multiple sensitising events"
          ]},
        ],
        compute(v){
          const cpra=+v.cpra;
          if(cpra<0||cpra>100||!cpra&&cpra!==0) return null;
          let cat="";
          if(cpra<10) cat="Non-sensitised";
          else if(cpra<80) cat="Moderately sensitised";
          else if(cpra<98) cat="Highly sensitised";
          else cat="Very highly sensitised";
          return {val:cpra.toFixed(0),unit:`% cPRA — ${cat}`,sec:`Sensitising history: ${v.sensitising||"not specified"}`};
        },
        interpret(r,v){
          const cpra=+r.val;
          if(cpra<10) return {c:"#16a34a",t:`cPRA ${r.val}% — Non-sensitised. Compatible donor pool is large. Standard crossmatch and allocation procedures apply. Monitor antibodies every 3 months on the waitlist and after any sensitising event (transfusion, failed transplant, pregnancy). ${GUIDELINE_CLOSING}`};
          if(cpra<80) return {c:"#ca8a04",t:`cPRA ${r.val}% — Moderately sensitised. Compatible donor pool is reduced. Identify unacceptable antigens via single-antigen bead assay. Consider listing at multiple centres where permitted. Avoid unnecessary blood transfusions (use erythropoiesis-stimulating agents preferentially). Monitor antibodies every 3 months. Living donor evaluation is encouraged to expand options. ${GUIDELINE_CLOSING}`};
          if(cpra<98) return {c:"#ea580c",t:`cPRA ${r.val}% — Highly sensitised. Compatible donor pool is significantly reduced. Immunology/histocompatibility laboratory input is essential. Desensitisation protocols (IVIG ± rituximab ± plasmapheresis) may be considered at experienced centres. Paired kidney exchange programmes and acceptable mismatch programmes may expand options. Monitor antibodies frequently (every 1–3 months). ${GUIDELINE_CLOSING}`};
          return {c:"#dc2626",t:`cPRA ${r.val}% — Very highly sensitised (≥98%). Compatible donor pool is extremely limited. UNOS allocation provides priority points at this level. Intensive desensitisation (IVIG, rituximab, plasmapheresis, imlifidase where available) should be discussed at a high-volume transplant centre. Paired kidney exchange and multi-listing strategies are strongly recommended. Histocompatibility laboratory collaboration for virtual crossmatch optimisation is essential. ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"tx_frailty", name:"Frailty Screen — Fried Criteria", ref:"Fried LP et al., J Gerontol 2001;56:M146-M156; KDIGO Transplant Candidacy 2020", tag:"Pre-Transplant Frailty Assessment",
        formula:"Fried Frailty Phenotype — score 0–5:\n  1. Unintentional weight loss >4.5 kg (10 lbs) in past year\n  2. Self-reported exhaustion (CES-D scale)\n  3. Low grip strength (below sex/BMI-adjusted 20th percentile)\n  4. Slow gait speed (5-metre walk >6–7 seconds, sex/height-adjusted)\n  5. Low physical activity (below sex-adjusted 20th percentile kcal/week)\nRobust: 0 | Pre-frail: 1–2 | Frail: ≥3",
        note:"Frailty is independently associated with increased mortality, graft loss, delayed graft function, and prolonged hospitalisation after kidney transplantation. KDIGO 2020 acknowledges frailty assessment as emerging best practice for transplant candidacy evaluation. The Fried phenotype (2001) is the most widely validated frailty instrument. Frailty is potentially modifiable through prehabilitation (exercise, nutritional optimisation). Frailty alone is not an absolute contraindication to transplantation but should inform shared decision-making.",
        inputs:[
          {id:"wt_loss",label:"Unintentional weight loss >4.5 kg (10 lbs) in past year",type:"checkbox"},
          {id:"exhaustion",label:"Self-reported exhaustion (feeling that everything is an effort, or could not get going, most days)",type:"checkbox"},
          {id:"grip",label:"Low grip strength (below sex- and BMI-adjusted 20th percentile)",type:"checkbox"},
          {id:"gait",label:"Slow gait speed (5-metre walk time >6–7 seconds, adjusted for sex and height)",type:"checkbox"},
          {id:"activity",label:"Low physical activity (below sex-adjusted 20th percentile for kcal/week)",type:"checkbox"},
        ],
        compute(v){
          const score = [v.wt_loss,v.exhaustion,v.grip,v.gait,v.activity].filter(Boolean).length;
          let cat = "Robust";
          if(score>=3) cat="Frail";
          else if(score>=1) cat="Pre-frail";
          return {val:score,unit:`/5 — ${cat}`};
        },
        interpret(r){
          const s=r.val;
          if(s===0) return {c:"#16a34a",t:`Fried score 0/5 — Robust. No frailty criteria met. Standard transplant candidacy evaluation may proceed. Continued physical activity and nutritional maintenance are recommended. ${GUIDELINE_CLOSING}`};
          if(s<=2) return {c:"#ca8a04",t:`Fried score ${s}/5 — Pre-frail. This is associated with an intermediate risk of adverse post-transplant outcomes. Prehabilitation (structured exercise programme, nutritional optimisation, protein supplementation) is recommended before transplant listing where feasible. Reassessment after 3–6 months of prehabilitation may demonstrate improvement. Frailty alone should not preclude transplant listing but should inform shared decision-making regarding risk. ${GUIDELINE_CLOSING}`};
          return {c:"#dc2626",t:`Fried score ${s}/5 — Frail. Frailty is independently associated with increased post-transplant mortality, graft loss, and prolonged hospitalisation. A multidisciplinary prehabilitation programme (physiotherapy, dietetics, geriatric medicine input) is strongly recommended. Transplant listing decisions should involve a careful risk-benefit discussion with the patient, incorporating frailty status alongside all other candidacy factors. Reassessment after a defined prehabilitation period is advisable. Frailty may be modifiable — a trial of prehabilitation before a final listing decision is appropriate. ${GUIDELINE_CLOSING}`};
        }
      },
      // ── REFERENCE PANELS ──
      {
        id:"tx_contraindications", name:"[REF] Absolute Contraindications Panel", ref:"KDIGO Transplant Candidacy 2020; AST/ASTS Consensus", tag:"Pre-Transplant — Absolute Contraindications",
        formula:"Absolute contraindications to kidney transplantation:\n  1. Active untreated malignancy (except non-melanoma skin, incidental small renal)\n  2. Active untreated infection (TB, HIV with detectable viral load, active hepatitis)\n  3. Uncontrolled substance dependence (active within 6 months)\n  4. Severe irreversible multi-organ failure\n  5. Life expectancy <1 year independent of renal disease\n  6. Active non-adherence to medical therapy (documented pattern)\n  7. Severe uncorrectable cardiac disease (inoperable, EF <20% without revascularisation option)\n  8. Active psychosis or severe cognitive impairment precluding informed consent",
        note:"These represent widely accepted absolute contraindications. Relative contraindications (age >80, BMI >40, recurrent oxalate nephropathy, active lupus, etc.) require individual MDT assessment. Some centres treat HIV+ patients with undetectable VL as eligible — consult local protocol.",
        inputs:[
          {id:"malig",label:"Active untreated malignancy",type:"checkbox"},
          {id:"infect",label:"Active untreated systemic infection (TB, HIV VL detectable)",type:"checkbox"},
          {id:"substance",label:"Active substance dependence (<6 months abstinence)",type:"checkbox"},
          {id:"mof",label:"Severe irreversible multi-organ failure",type:"checkbox"},
          {id:"life1yr",label:"Life expectancy <1 year independent of kidney disease",type:"checkbox"},
          {id:"nonadhere",label:"Documented active non-adherence pattern",type:"checkbox"},
          {id:"cardiac_sev",label:"Severe uncorrectable cardiac disease",type:"checkbox"},
          {id:"cognitive",label:"Severe cognitive impairment/active psychosis (no capacity)",type:"checkbox"},
        ],
        compute(v){
          const hits=[v.malig,v.infect,v.substance,v.mof,v.life1yr,v.nonadhere,v.cardiac_sev,v.cognitive].filter(Boolean);
          return {val:hits.length,unit:hits.length>0?"ABSOLUTE CONTRAINDICATION(S) PRESENT":"NO ABSOLUTE CONTRAINDICATIONS IDENTIFIED"};
        },
        interpret(r){
          if(r.val===0) return {c:"#16a34a",t:`No absolute contraindications identified. Proceed with full candidacy evaluation including cardiovascular, malignancy, infection screening, and psychosocial assessment. ${GUIDELINE_CLOSING}`};
          return {c:"#dc2626",t:`${r.val} absolute contraindication(s) present. Transplant listing cannot proceed until all absolute contraindications are resolved. MDT review is required to determine whether any identified factor is potentially reversible (e.g., infection treatment, substance rehabilitation, cardiac intervention). ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"tx_infection_screen", name:"[REF] Pre-Transplant Infection Screening", ref:"KDIGO 2020; AST Infectious Disease Guidelines; ERA-EDTA Best Practice", tag:"Pre-Transplant — Infection Checklist",
        formula:"Required screening:\n  TB: IGRA (QuantiFERON/T-SPOT) + CXR (mandatory)\n  HIV: 4th-gen Ag/Ab (mandatory)\n  HBV: HBsAg, anti-HBs, anti-HBc (mandatory)\n  HCV: Anti-HCV Ab + NAT if positive (mandatory)\n  CMV: IgG serology (mandatory — determines prophylaxis)\n  EBV: IgG serology (mandatory — PTLD risk stratification)\n  VZV: IgG serology (vaccinate if negative)\n  Syphilis: RPR/VDRL (mandatory)\n  Strongyloides: IgG if endemic exposure\n  Chagas: IgG if endemic exposure (Latin America)",
        note:"IGRA preferred over PPD in ESRD (PPD unreliable due to anergy). All HBV-seronegative candidates should receive HBV vaccination (high-dose/adjuvanted preferred in ESRD). CMV D+/R- is highest-risk combination for post-transplant CMV disease. EBV R- receiving EBV D+ organ is highest risk for PTLD.",
        inputs:[
          {id:"tb",label:"TB screen (IGRA + CXR) completed",type:"checkbox"},
          {id:"hiv",label:"HIV 4th-gen Ag/Ab completed",type:"checkbox"},
          {id:"hbv",label:"HBV panel (HBsAg, anti-HBs, anti-HBc) completed",type:"checkbox"},
          {id:"hcv",label:"HCV Ab (+/- NAT) completed",type:"checkbox"},
          {id:"cmv",label:"CMV IgG completed",type:"checkbox"},
          {id:"ebv",label:"EBV IgG completed",type:"checkbox"},
          {id:"vzv",label:"VZV IgG completed",type:"checkbox"},
          {id:"syphilis",label:"Syphilis screen (RPR/VDRL) completed",type:"checkbox"},
        ],
        compute(v){
          const done=[v.tb,v.hiv,v.hbv,v.hcv,v.cmv,v.ebv,v.vzv,v.syphilis].filter(Boolean).length;
          return {val:`${done}/8`,unit:"mandatory screens completed",sec:done===8?"All mandatory screens complete":"INCOMPLETE — listing cannot proceed"};
        },
        interpret(r,v){
          const done=[v.tb,v.hiv,v.hbv,v.hcv,v.cmv,v.ebv,v.vzv,v.syphilis].filter(Boolean).length;
          const missing=[];
          if(!v.tb) missing.push("TB (IGRA+CXR)");
          if(!v.hiv) missing.push("HIV");
          if(!v.hbv) missing.push("HBV panel");
          if(!v.hcv) missing.push("HCV");
          if(!v.cmv) missing.push("CMV IgG");
          if(!v.ebv) missing.push("EBV IgG");
          if(!v.vzv) missing.push("VZV IgG");
          if(!v.syphilis) missing.push("Syphilis");
          if(done===8) return {c:"#16a34a",t:`All 8 mandatory infection screens completed. Proceed with result interpretation, vaccination as indicated (HBV if anti-HBs <10, VZV if seronegative), and CMV/EBV risk stratification for post-transplant prophylaxis planning. ${GUIDELINE_CLOSING}`};
          return {c:"#dc2626",t:`${done}/8 screens completed. Outstanding: ${missing.join(", ")}. All mandatory screens must be completed before transplant listing can proceed. ${GUIDELINE_CLOSING}`};
        }
      },
      // ── POST-TRANSPLANT ──
      {
        id:"tx_egfr_surv", name:"Post-Transplant eGFR Surveillance", ref:"KDIGO Transplant Recipient 2009 Ch.1; Loupy et al., NEJM 2018", tag:"Post-Transplant — eGFR Trajectory & Rejection Risk",
        formula:"Expected eGFR trajectory after kidney transplant:\n  Week 1: Rapid rise (DGF may delay)\n  Month 1-3: Plateau at nadir-adjusted peak\n  Month 3-12: Stable or slow improvement\n  Year 1+: Stable; decline >5 mL/min/yr = investigate\n\nRejection flags:\n  - Cr rise >20% from nadir = investigate\n  - New proteinuria (UPCR >500) = investigate\n  - de novo DSA = high risk for AMR",
        note:"GUIDELINE-BASED TOOL — This calculator applies published clinical thresholds but is not itself a validated composite scoring instrument. Interpret within clinical context.\n\nAny sustained eGFR decline should prompt investigation: non-adherence screen, tacrolimus level, urinalysis, DSA testing, renal ultrasound, and consideration of transplant biopsy. Differential includes rejection (TCMR/AMR), BK nephropathy, recurrent disease, CNI toxicity, and obstruction.",
        inputs:[
          {id:"egfr_nadir",label:"Best (nadir-adjusted) eGFR post-transplant",unit:"mL/min/1.73m²",type:"number",ph:"55"},
          {id:"egfr_now",label:"Current eGFR",unit:"mL/min/1.73m²",type:"number",ph:"42"},
          {id:"months_post",label:"Months post-transplant",unit:"months",type:"number",ph:"18"},
          {id:"new_proteinuria",label:"New proteinuria (UPCR >500 mg/g)",type:"checkbox"},
          {id:"dnDSA",label:"de novo DSA detected",type:"checkbox"},
          {id:"tac_low",label:"Tacrolimus trough sub-therapeutic",type:"checkbox"},
        ],
        compute(v){
          const best=+v.egfr_nadir,now=+v.egfr_now,mo=+v.months_post;
          if(!best||!now||!mo) return null;
          const decline=best-now;
          const annualRate=mo>0?(decline/(mo/12)):0;
          return {val:now.toFixed(0),unit:"mL/min/1.73m²",sec:`Decline from best: ${decline.toFixed(0)} | Annual rate: ${annualRate.toFixed(1)} mL/min/yr`};
        },
        interpret(r,v){
          const best=+v.egfr_nadir,now=+v.egfr_now,mo=+v.months_post;
          const decline=best-now;
          const pctDrop=(decline/best)*100;
          const annualRate=mo>0?(decline/(mo/12)):0;
          const flags=[v.new_proteinuria&&"new proteinuria",v.dnDSA&&"de novo DSA",v.tac_low&&"sub-therapeutic tacrolimus"].filter(Boolean);
          if(pctDrop>20||annualRate>5||flags.length>0){
            return {c:"#dc2626",t:`eGFR ${now} — Significant decline (${pctDrop.toFixed(0)}% from best, ${annualRate.toFixed(1)} mL/min/yr).${flags.length>0?" Flags: "+flags.join(", ")+".":""} Transplant biopsy is strongly recommended. Differential: acute/chronic rejection, BK nephropathy, CNI toxicity, recurrent disease, obstruction. Check tacrolimus level, BK PCR, DSA, urine microscopy, and renal ultrasound. ${GUIDELINE_CLOSING}`};
          }
          if(pctDrop>10||annualRate>3){
            return {c:"#ca8a04",t:`eGFR ${now} — Moderate decline (${pctDrop.toFixed(0)}% from best). Enhanced surveillance recommended: tacrolimus level, DSA, BK PCR, urinalysis. Consider protocol biopsy if decline persists. ${GUIDELINE_CLOSING}`};
          }
          return {c:"#16a34a",t:`eGFR ${now} — Stable trajectory (${pctDrop.toFixed(0)}% from best, ${annualRate.toFixed(1)} mL/min/yr). Routine surveillance: tacrolimus level, urinalysis, DSA per protocol. ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"tx_banff", name:"Banff 2022 Rejection Classifier", ref:"Naesens et al., Am J Transplant 2024;24:338-349; Banff Foundation 2022", tag:"Post-Transplant — TCMR + AMR/MVI Classification",
        formula:"TCMR (T-Cell Mediated Rejection):\n  Borderline: i1+t1 (suspicious)\n  Grade IA: i2+t2 | Grade IB: i2+t3 or i3+t2/t3\n  Grade IIA: v1 (intimal arteritis) | Grade IIB: v2\n  Grade III: v3 (transmural/fibrinoid necrosis)\n\nAMR/MVI (Antibody-Mediated Rejection):\n  Requires ALL 3 criteria:\n  1. MVI: [g+ptc] ≥2 (or validated transcript)\n  2. Evidence of antibody interaction: C4d≥2 (IF) or C4d>0 (IHC) or molecular\n  3. DSA positive (HLA or validated non-HLA)\n\n  Active AMR: active features only (cg=0, ptcml=0)\n  Chronic active AMR: active + chronic (cg>0 or severe ptcml)\n  Probable AMR: DSA+ but MVI below threshold\n  MVI DSA-/C4d-: MVI present but no DSA, no C4d",
        note:"Banff 2022 introduced MVI as a standalone category when DSA and C4d are negative. This is a descriptive phenotype requiring further research. TCMR and AMR can coexist (mixed rejection). Biopsy-based transcript diagnostics (e.g., MMDx) can substitute for histologic MVI if validated. Always correlate with clinical context, DSA trajectory, and graft function.",
        inputs:[
          {id:"i_score",label:"i score (interstitial inflammation)",type:"select",options:["i0","i1","i2","i3"]},
          {id:"t_score",label:"t score (tubulitis)",type:"select",options:["t0","t1","t2","t3"]},
          {id:"v_score",label:"v score (intimal arteritis)",type:"select",options:["v0","v1","v2","v3"]},
          {id:"g_score",label:"g score (glomerulitis)",type:"select",options:["g0","g1","g2","g3"]},
          {id:"ptc_score",label:"ptc score (peritubular capillaritis)",type:"select",options:["ptc0","ptc1","ptc2","ptc3"]},
          {id:"c4d",label:"C4d staining",type:"select",options:["Negative (C4d0)","Minimal (C4d1)","Focal (C4d2)","Diffuse (C4d3)"]},
          {id:"cg_score",label:"cg score (transplant glomerulopathy)",type:"select",options:["cg0","cg1a","cg1b","cg2","cg3"]},
          {id:"dsa_status",label:"Donor-Specific Antibody (DSA)",type:"select",options:["Negative","Positive (HLA Class I)","Positive (HLA Class II)","Positive (HLA Class I + II)"]},
        ],
        compute(v){
          const i=parseInt(v.i_score?.replace("i",""))||0;
          const t=parseInt(v.t_score?.replace("t",""))||0;
          const vv=parseInt(v.v_score?.replace("v",""))||0;
          const g=parseInt(v.g_score?.replace("g",""))||0;
          const ptc=parseInt(v.ptc_score?.replace("ptc",""))||0;
          const cg=(v.cg_score||"cg0")!=="cg0"?1:0;
          const c4dPos=v.c4d?.includes("Focal")||v.c4d?.includes("Diffuse");
          const dsaPos=v.dsa_status!=="Negative";
          const mvi=g+ptc;

          let tcmr="None";
          if(vv>=3) tcmr="Grade III";
          else if(vv===2) tcmr="Grade IIB";
          else if(vv===1) tcmr="Grade IIA";
          else if((i>=2&&t>=3)||(i>=3&&t>=2)) tcmr="Grade IB";
          else if(i>=2&&t>=2) tcmr="Grade IA";
          else if(i>=1&&t>=1) tcmr="Borderline";

          let amr="None";
          if(mvi>=2&&(c4dPos)&&dsaPos){
            amr=cg?"Chronic Active AMR":"Active AMR";
          } else if(mvi>=2&&dsaPos&&!c4dPos){
            amr="Probable AMR (DSA+, C4d-)";
          } else if(mvi>=2&&!dsaPos&&!c4dPos){
            amr="MVI, DSA-negative, C4d-negative";
          }

          return {val:`TCMR: ${tcmr} | AMR: ${amr}`,unit:"",sec:`MVI score: g${g}+ptc${ptc}=${mvi} | C4d: ${v.c4d} | DSA: ${v.dsa_status} | cg: ${v.cg_score}`};
        },
        interpret(r,v){
          const hasTCMR=!r.val.includes("TCMR: None");
          const hasAMR=!r.val.includes("AMR: None");
          if(hasTCMR&&hasAMR) return {c:"#991b1b",t:`MIXED REJECTION: ${r.val}. This carries the worst prognosis. Treatment: high-dose IV methylprednisolone (TCMR) + anti-rejection therapy for AMR (plasmapheresis, IVIG, rituximab) as indicated. Urgent transplant nephrology and pathology review. ${GUIDELINE_CLOSING}`};
          if(r.val.includes("Grade III")||r.val.includes("Grade IIB")) return {c:"#dc2626",t:`Severe TCMR: ${r.val}. IV methylprednisolone 500mg x3d. If steroid-resistant: ATG. Consider concurrent subclinical AMR. ${GUIDELINE_CLOSING}`};
          if(r.val.includes("Active AMR")||r.val.includes("Chronic Active AMR")) return {c:"#dc2626",t:`${r.val}. Treatment: plasmapheresis + IVIG +/- rituximab. Optimise baseline immunosuppression. Chronic active AMR has limited treatment options and carries significant graft loss risk. ${GUIDELINE_CLOSING}`};
          if(hasTCMR) return {c:"#ea580c",t:`${r.val}. IV methylprednisolone pulse. Optimise tacrolimus target. Repeat biopsy if no response at 7-10 days. ${GUIDELINE_CLOSING}`};
          if(r.val.includes("Probable AMR")) return {c:"#ca8a04",t:`${r.val}. Enhanced surveillance: repeat DSA, repeat biopsy 3-6 months. Optimise immunosuppression. Consider molecular diagnostics (MMDx). ${GUIDELINE_CLOSING}`};
          if(r.val.includes("MVI, DSA-negative")) return {c:"#ca8a04",t:`${r.val}. This is a Banff 2022 descriptive category of unclear aetiology. Consider non-HLA antibodies, viral infection, drug toxicity. Enhanced surveillance. Research is ongoing. ${GUIDELINE_CLOSING}`};
          return {c:"#16a34a",t:`No rejection criteria met on current biopsy scores. Correlate with clinical context, graft function trajectory, and DSA status. ${GUIDELINE_CLOSING}`};
        }
      },
      // ── IMMUNOSUPPRESSION TDM ──
      {
        id:"tx_csa_tdm", name:"Cyclosporine TDM (C0 + C2)", ref:"KDIGO Transplant Recipient 2009; CONCERT Group Consensus; Levy et al., Transplantation 2002", tag:"Immunosuppression — CsA Therapeutic Drug Monitoring",
        formula:"C0 (trough) targets:\n  Month 0-3: 150-300 ng/mL\n  Month 3-12: 100-200 ng/mL\n  >12 months: 75-150 ng/mL\n\nC2 (2h post-dose) targets:\n  Month 0-3: 1200-1500 ng/mL (de novo)\n  Month 3-12: 800-1000 ng/mL\n  >12 months: 500-600 ng/mL\n\nC2 correlates better with AUC0-4 than C0 (r² ~0.86 vs 0.61).",
        note:"C2 monitoring is preferred where available as it better reflects drug exposure (AUC0-4). CsA absorption (C2/C0 ratio) increases over time post-transplant. CYP3A4/5 and P-gp interactions are significant (diltiazem, ketoconazole increase levels; rifampicin, phenytoin decrease). Give sirolimus 4h after CsA to reduce interaction. Neoral (microemulsion) has more predictable absorption than Sandimmune.",
        inputs:[
          {id:"c0",label:"C0 (Trough Level)",unit:"ng/mL",type:"number",ph:"175"},
          {id:"c2",label:"C2 (2-Hour Post-Dose Level)",unit:"ng/mL",type:"number",ph:"950"},
          {id:"period",label:"Time Post-Transplant",type:"select",options:["0-3 months","3-12 months",">12 months"]},
        ],
        compute(v){
          const c0=+v.c0,c2=+v.c2,p=v.period;
          const targets={
            "0-3 months":{c0:[150,300],c2:[1200,1500]},
            "3-12 months":{c0:[100,200],c2:[800,1000]},
            ">12 months":{c0:[75,150],c2:[500,600]},
          };
          const tgt=targets[p]||targets["0-3 months"];
          const c0Status=c0?c0<tgt.c0[0]?"SUB-THERAPEUTIC":c0>tgt.c0[1]?"SUPRA-THERAPEUTIC":"WITHIN TARGET":"not measured";
          const c2Status=c2?c2<tgt.c2[0]?"SUB-THERAPEUTIC":c2>tgt.c2[1]?"SUPRA-THERAPEUTIC":"WITHIN TARGET":"not measured";
          const absorption=c0&&c2?(c2/c0).toFixed(1):"N/A";
          return {val:`C0: ${c0Status} | C2: ${c2Status}`,unit:"",sec:`C0: ${c0||"-"} (target ${tgt.c0[0]}-${tgt.c0[1]}) | C2: ${c2||"-"} (target ${tgt.c2[0]}-${tgt.c2[1]}) | Absorption C2/C0: ${absorption}`};
        },
        interpret(r,v){
          const hasSub=r.val.includes("SUB");
          const hasSupra=r.val.includes("SUPRA");
          if(hasSupra) return {c:"#dc2626",t:`${r.val}. Nephrotoxicity risk: check creatinine trend, magnesium, uric acid. Consider dose reduction. Monitor for tremor, gingival hyperplasia, hirsutism. ${GUIDELINE_CLOSING}`};
          if(hasSub) return {c:"#ea580c",t:`${r.val}. Rejection risk elevated. Increase dose or check adherence, drug interactions (CYP3A4 inducers), GI absorption. ${GUIDELINE_CLOSING}`};
          return {c:"#16a34a",t:`${r.val}. Continue current dosing. Monitor levels per protocol. ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"tx_tac_tdm", name:"Tacrolimus TDM", ref:"KDIGO 2009; ELITE-Symphony (Ekberg et al., NEJM 2007); Agur et al., Clin Transplant 2023", tag:"Immunosuppression — Tacrolimus Trough + IPV",
        formula:"C0 (trough) targets (with MMF + steroids):\n  Month 0-1: 8-12 ng/mL (standard) or 6-10 (low-dose ELITE-Symphony)\n  Month 1-3: 6-10 ng/mL\n  Month 3-12: 5-8 ng/mL\n  >12 months: 5-7 ng/mL\n\nNephrotoxicity flag: C0 persistently >12\nIPV (Intra-Patient Variability): CV% = (SD/mean)×100\n  CV% >30% = high IPV → increased graft loss risk",
        note:"KDIGO suggests 3-15 ng/mL in months 1-4 (low quality evidence). Recent evidence (Agur 2023, multicenter n=11868) supports optimal range of 5.0-7.9 ng/mL at 2-12 months and 5.0-6.9 ng/mL at 12-72 months for best composite outcomes. High IPV (CV% >30%) is independently associated with dnDSA and graft loss. Starting dose: 0.05-0.075 mg/kg BD (ELITE-Symphony low-dose). Prolonged-release (Advagraf/Envarsus) may reduce IPV.",
        inputs:[
          {id:"tac_c0",label:"Tacrolimus C0 (Trough)",unit:"ng/mL",type:"number",ph:"7.2"},
          {id:"period",label:"Time Post-Transplant",type:"select",options:["0-1 months","1-3 months","3-12 months",">12 months"]},
          {id:"ipv_mean",label:"Mean of last 5 trough levels (for IPV)",unit:"ng/mL",type:"number",ph:"6.8"},
          {id:"ipv_sd",label:"SD of last 5 trough levels",unit:"ng/mL",type:"number",ph:"2.1"},
        ],
        compute(v){
          const c0=+v.tac_c0,p=v.period;
          const targets={
            "0-1 months":[8,12],
            "1-3 months":[6,10],
            "3-12 months":[5,8],
            ">12 months":[5,7],
          };
          const tgt=targets[p]||[5,8];
          const status=c0?c0<tgt[0]?"SUB-THERAPEUTIC":c0>tgt[1]?"SUPRA-THERAPEUTIC":"WITHIN TARGET":"not measured";
          const nephrotox=c0>12?"NEPHROTOXICITY FLAG":"";
          const mean=+v.ipv_mean,sd=+v.ipv_sd;
          const ipv=mean&&sd?(sd/mean*100).toFixed(1):null;
          return {val:status,unit:`C0: ${c0||"-"} ng/mL (target ${tgt[0]}-${tgt[1]})`,sec:`${nephrotox?nephrotox+" | ":""}IPV CV%: ${ipv||"N/A"}${ipv&&+ipv>30?" — HIGH (>30%)":""}`};
        },
        interpret(r,v){
          const c0=+v.tac_c0;
          const mean=+v.ipv_mean,sd=+v.ipv_sd;
          const ipv=mean&&sd?(sd/mean*100):null;
          let msg="";
          if(r.val==="SUPRA-THERAPEUTIC") msg=`Tacrolimus ${c0} ng/mL — above target. Nephrotoxicity risk (tremor, hypertension, hyperglycaemia, hyperkalaemia, hypomagnesaemia). Reduce dose. Check creatinine trend.`;
          else if(c0>12) msg=`Tacrolimus ${c0} ng/mL — NEPHROTOXICITY FLAG (>12). Urgent dose reduction. Check Mg, K, glucose.`;
          else if(r.val==="SUB-THERAPEUTIC") msg=`Tacrolimus ${c0} ng/mL — below target. Rejection risk. Verify adherence, check CYP3A5 genotype if available, review drug interactions (rifampicin, phenytoin, St John’s wort).`;
          else msg=`Tacrolimus ${c0} ng/mL — within target. Continue current dosing.`;
          if(ipv&&ipv>30) msg+=` HIGH IPV (CV% ${ipv.toFixed(1)}%) — independently associated with dnDSA and graft loss. Consider conversion to prolonged-release formulation, adherence intervention, or pharmacist review.`;
          return {c:r.val==="SUPRA-THERAPEUTIC"||c0>12?"#dc2626":r.val==="SUB-THERAPEUTIC"?"#ea580c":"#16a34a",t:`${msg} ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"tx_siro_tdm", name:"Sirolimus TDM", ref:"KDIGO 2009; Stratta, Medscape 2003; ScienceDirect TDM Review 2016", tag:"Immunosuppression — Sirolimus Trough (With-CNI vs CNI-Free)",
        formula:"Sirolimus C0 targets:\n  With CNI (reduced-dose CNI):\n    Target sirolimus: 4-8 ng/mL\n    Target CNI: TAC 4-6, CsA 100-150 ng/mL\n    Combined level <20 ng/mL preferred\n  CNI-free (SRL + MMF + steroids):\n    0-12 months: 10-15 ng/mL\n    >12 months: 8-12 ng/mL (some centres 6-10)\n  Toxicity: C0 >15 ng/mL → dyslipidaemia, thrombocytopenia, leukopenia\n\nKDIGO: Avoid SRL + full-dose CNI (potentiates nephrotoxicity)\nDo not start SRL until graft function established and wounds healed",
        note:"Sirolimus t½ ~60h (adults). C0 correlates well with AUC. Give 4h after CsA (pharmacokinetic interaction). No significant interaction with tacrolimus. Contraindications to CNI→SRL conversion: proteinuria >800 mg/d, eGFR <40, recent rejection (<3mo), uncontrolled dyslipidaemia. KDIGO recommends monitoring levels (2C).",
        inputs:[
          {id:"srl_c0",label:"Sirolimus C0 (Trough)",unit:"ng/mL",type:"number",ph:"8.5"},
          {id:"regimen",label:"Regimen",type:"select",options:["With reduced-dose CNI","CNI-free (SRL + MMF + steroids)"]},
          {id:"months",label:"Months post-transplant",unit:"months",type:"number",ph:"12"},
        ],
        compute(v){
          const c0=+v.srl_c0,cni=v.regimen?.includes("With");
          if(!c0) return null;
          const mo=+v.months||6;
          let lo,hi;
          if(cni){lo=4;hi=8;}
          else{lo=mo<=12?10:8;hi=mo<=12?15:12;}
          const status=c0<lo?"SUB-THERAPEUTIC":c0>hi?"SUPRA-THERAPEUTIC":"WITHIN TARGET";
          return {val:status,unit:`C0: ${c0} ng/mL (target ${lo}-${hi} for ${cni?"with-CNI":"CNI-free"})`,sec:c0>15?"TOXICITY RISK (>15)":""};
        },
        interpret(r,v){
          const c0=+v.srl_c0;
          if(c0>15) return {c:"#dc2626",t:`Sirolimus ${c0} ng/mL — above 15. Toxicity risk: check lipid profile, FBC (thrombocytopenia, leukopenia), proteinuria. Dose reduction required. ${GUIDELINE_CLOSING}`};
          if(r.val==="SUPRA-THERAPEUTIC") return {c:"#ea580c",t:`Sirolimus ${c0} ng/mL — above target. Check lipids, FBC. Consider dose reduction. ${GUIDELINE_CLOSING}`};
          if(r.val==="SUB-THERAPEUTIC") return {c:"#ea580c",t:`Sirolimus ${c0} ng/mL — below target. Rejection risk. Increase dose. Check drug interactions and adherence. ${GUIDELINE_CLOSING}`};
          return {c:"#16a34a",t:`Sirolimus ${c0} ng/mL — within target. Continue. Monitor lipids and FBC at each visit. ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"tx_evero_tdm", name:"Everolimus TDM + CNI→mTOR Conversion", ref:"TRANSFORM Study; Budde et al., Am J Transplant 2011; KDIGO 2009", tag:"Immunosuppression — Everolimus Trough + Conversion Eligibility",
        formula:"Everolimus C0 targets (with reduced-dose CNI):\n  Target: 3-8 ng/mL\n  With TAC: target TAC 4-6 ng/mL\n  With CsA: target CsA C2 350-450 ng/mL\n\nConversion eligibility (CNI → mTOR):\n  eGFR >40 mL/min | Proteinuria <800 mg/d\n  No rejection in past 3 months\n  Wounds fully healed | Dyslipidaemia controlled",
        note:"Everolimus t½ ~28-35h (shorter than sirolimus). Does not potentiate CNI nephrotoxicity to the same degree as sirolimus when combined at appropriate levels. TRANSFORM study: EVR 3-8 ng/mL + reduced TAC (5-8 ng/mL standard) non-inferior to standard TAC + MMF.",
        inputs:[
          {id:"evr_c0",label:"Everolimus C0 (Trough)",unit:"ng/mL",type:"number",ph:"5.5"},
          {id:"egfr_conv",label:"eGFR (for conversion eligibility)",unit:"mL/min/1.73m²",type:"number",ph:"48"},
          {id:"proteinuria",label:"Proteinuria",unit:"mg/day",type:"number",ph:"200"},
          {id:"recent_rej",label:"Rejection in past 3 months",type:"checkbox"},
          {id:"wounds_healed",label:"Surgical wounds fully healed",type:"checkbox"},
        ],
        compute(v){
          const c0=+v.evr_c0;
          if(!c0) return null;
          const status=c0<3?"SUB-THERAPEUTIC":c0>8?"SUPRA-THERAPEUTIC":"WITHIN TARGET";
          const eligible=+v.egfr_conv>=40&&+v.proteinuria<800&&!v.recent_rej&&v.wounds_healed;
          return {val:status,unit:`C0: ${c0} ng/mL (target 3-8)`,sec:`Conversion eligibility: ${eligible?"ELIGIBLE":"NOT ELIGIBLE"}`};
        },
        interpret(r,v){
          const c0=+v.evr_c0;
          const eligible=+v.egfr_conv>=40&&+v.proteinuria<800&&!v.recent_rej&&v.wounds_healed;
          let msg=c0>8?`Everolimus ${c0} — above target. Check lipids, FBC, proteinuria. Reduce dose.`:c0<3?`Everolimus ${c0} — below target. Increase dose.`:`Everolimus ${c0} — within target.`;
          if(!eligible){
            const reasons=[];
            if(+v.egfr_conv<40) reasons.push("eGFR <40");
            if(+v.proteinuria>=800) reasons.push("proteinuria ≥800");
            if(v.recent_rej) reasons.push("recent rejection");
            if(!v.wounds_healed) reasons.push("wounds not healed");
            msg+=` CNI→mTOR conversion NOT eligible: ${reasons.join(", ")}.`;
          } else msg+=` CNI→mTOR conversion eligible.`;
          return {c:c0>8||c0<3?"#ea580c":"#16a34a",t:`${msg} ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"tx_mmf_tdm", name:"MMF/EC-MPS — MPA TDM", ref:"APOMYGRE Trial; KDIGO 2009; Bergan et al., Ther Drug Monit 2021 (IATDMCT Consensus)", tag:"Immunosuppression — Mycophenolate Dosing & AUC",
        formula:"MPA AUC₀₋₁₂ target: 30-60 mg·h/L\n  <30 = under-exposed (rejection risk)\n  >60 = over-exposed (infection, leukopenia, GI toxicity)\n\nStandard dosing:\n  MMF: 1g BD (2g/day) with TAC; 1.5g BD with CsA\n  EC-MPS: 720mg BD (equimolar to MMF 1g BD)\n\nC0 poorly correlates with AUC. AUC-guided dosing (LSS) recommended.\nCsA reduces MPA exposure (inhibits enterohepatic circulation).",
        note:"AUC-guided dosing (APOMYGRE trial) reduced rejection vs fixed dosing. High inter-individual variability (>10-fold). AUC best estimated by limited sampling strategy (C0, C1, C2). EC-MPS has less predictable absorption for TDM. GI side effects (diarrhoea, nausea) are common and dose-limiting. Leukopenia: hold if WBC <3.0.",
        inputs:[
          {id:"mpa_auc",label:"MPA AUC₀₋₁₂ (if available)",unit:"mg·h/L",type:"number",ph:"42"},
          {id:"mmf_dose",label:"Current MMF Dose",unit:"mg/day",type:"number",ph:"2000"},
          {id:"formulation",label:"Formulation",type:"select",options:["MMF (Mycophenolate Mofetil / CellCept)","EC-MPS (Enteric-Coated / Myfortic)"]},
          {id:"cni_type",label:"Concurrent CNI",type:"select",options:["Tacrolimus","Cyclosporine","None (CNI-free)"]},
          {id:"wbc",label:"WBC (if available)",unit:"×10⁹/L",type:"number",ph:"6.5"},
        ],
        compute(v){
          const auc=+v.mpa_auc,dose=+v.mmf_dose,wbc=+v.wbc;
          let aucStatus=auc?auc<30?"UNDER-EXPOSED":auc>60?"OVER-EXPOSED":"WITHIN TARGET":"not measured";
          const leuko=wbc&&wbc<3.0?"LEUKOPENIA WARNING":"";
          return {val:aucStatus,unit:auc?`AUC: ${auc} mg·h/L (target 30-60)`:`Dose: ${dose||"-"} mg/day`,sec:`${leuko}${leuko?" | ":""}Formulation: ${v.formulation} | CNI: ${v.cni_type}`};
        },
        interpret(r,v){
          const auc=+v.mpa_auc,wbc=+v.wbc;
          let msg="";
          if(wbc&&wbc<3.0) msg=`WBC ${wbc} — LEUKOPENIA. Hold or reduce MMF. Check viral screen (CMV, BK). `;
          if(auc&&auc<30) msg+=`MPA AUC ${auc} — under-exposed. Rejection risk. Consider dose increase if tolerated. `;
          else if(auc&&auc>60) msg+=`MPA AUC ${auc} — over-exposed. Infection and GI toxicity risk. Consider dose reduction. `;
          else if(auc) msg+=`MPA AUC ${auc} — within target (30-60). Continue current dose. `;
          else msg+=`AUC not available. Consider limited sampling strategy (C0+C1+C2) for dose optimisation. Fixed dosing leads to >10-fold variability in exposure. `;
          if(v.cni_type==="Cyclosporine") msg+=`Note: CsA reduces MPA exposure by inhibiting enterohepatic circulation — higher MMF doses often required with CsA vs TAC. `;
          return {c:wbc&&wbc<3.0?"#dc2626":r.val==="UNDER-EXPOSED"?"#ea580c":r.val==="OVER-EXPOSED"?"#ca8a04":"#16a34a",t:`${msg}${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"tx_aza_tdm", name:"Azathioprine + TPMT/NUDT15 Pharmacogenomics", ref:"CPIC Guideline 2025 (Relling et al.); KDIGO 2009", tag:"Immunosuppression — Azathioprine Dosing by Genotype",
        formula:"CPIC 2025 Dose Recommendations:\n  TPMT Normal + NUDT15 Normal: Standard dose (1.5-2.5 mg/kg/day)\n  TPMT IM or NUDT15 IM: Start at 20-50% of normal dose\n  TPMT PM or NUDT15 PM: Avoid thiopurines or use 10% dose with close FBC monitoring\n  Compound IM (TPMT IM + NUDT15 IM): 20-50% dose (2025 update: greater reduction recommended)\n\nTherapeutic metabolite monitoring:\n  6-TGN target: 235-450 pmol/8×10⁸ RBC\n  6-MMP >5700 = hepatotoxicity risk",
        note:"TPMT deficiency affects ~10% of Caucasians (heterozygous). NUDT15 variants are most common in East Asian and Hispanic populations. Pre-treatment genotyping is recommended by CPIC, DPWG, and FDA labelling. Complete TPMT or NUDT15 deficiency (poor metaboliser) can cause life-threatening myelosuppression at standard doses. Azathioprine is a prodrug for mercaptopurine.",
        inputs:[
          {id:"tpmt",label:"TPMT Phenotype",type:"select",options:["Normal Metaboliser (*1/*1)","Intermediate Metaboliser (*1/*3A, *1/*3C)","Poor Metaboliser (*3A/*3A, *2/*3A)","Not tested"]},
          {id:"nudt15",label:"NUDT15 Phenotype",type:"select",options:["Normal Metaboliser (*1/*1)","Intermediate Metaboliser (*1/*3)","Poor Metaboliser (*3/*3)","Not tested"]},
          {id:"wt_aza",label:"Weight",unit:"kg",type:"number",ph:"70"},
          {id:"tgn",label:"6-TGN level (if available)",unit:"pmol/8×10⁸ RBC",type:"number",ph:"320"},
        ],
        compute(v){
          const tpmt=v.tpmt||"Not tested",nudt=v.nudt15||"Not tested",wt=+v.wt_aza;
          const tpmtPM=tpmt.includes("Poor"),tpmtIM=tpmt.includes("Intermediate");
          const nudtPM=nudt.includes("Poor"),nudtIM=nudt.includes("Intermediate");
          let doseFrac=1.0,category="Standard";
          if(tpmtPM||nudtPM){doseFrac=0.1;category="AVOID or 10% dose";}
          else if(tpmtIM&&nudtIM){doseFrac=0.3;category="Compound IM — 20-50% dose";}
          else if(tpmtIM||nudtIM){doseFrac=0.5;category="IM — 50% dose start";}
          const stdDose=wt?Math.round(wt*2):"-";
          const adjDose=wt?Math.round(wt*2*doseFrac):"-";
          return {val:category,unit:`Standard: ${stdDose} mg/day | Adjusted: ${adjDose} mg/day`,sec:`TPMT: ${tpmt} | NUDT15: ${nudt}${v.tgn?` | 6-TGN: ${v.tgn}`:""}`};
        },
        interpret(r,v){
          const tgn=+v.tgn;
          const tpmtPM=v.tpmt?.includes("Poor"),nudtPM=v.nudt15?.includes("Poor");
          let msg=`${r.val}. `;
          if(tpmtPM||nudtPM) msg+=`AVOID thiopurines if possible. If essential: use ≤10% dose with weekly FBC for first 8 weeks, then monthly. Life-threatening myelosuppression can occur at standard doses. Consider alternative immunosuppressant (MMF). `;
          else if(r.val.includes("Compound")) msg+=`Start at 20-50% of standard dose (CPIC 2025). Weekly FBC for 8 weeks, then fortnightly for 8 weeks, then monthly. `;
          else if(r.val.includes("IM")) msg+=`Start at 50% dose. FBC weekly for 4 weeks, then fortnightly for 8 weeks, then monthly. Titrate based on FBC and 6-TGN if available. `;
          else msg+=`Standard dose appropriate. FBC at 2, 4, 8 weeks then monthly. `;
          if(tgn){
            if(tgn<235) msg+=`6-TGN ${tgn} — sub-therapeutic. Consider dose increase if FBC allows. `;
            else if(tgn>450) msg+=`6-TGN ${tgn} — elevated. Myelotoxicity risk. Consider dose reduction. `;
            else msg+=`6-TGN ${tgn} — within target (235-450). `;
          }
          if(v.tpmt==="Not tested"||v.nudt15==="Not tested") msg+=`Pre-treatment TPMT/NUDT15 genotyping is recommended by CPIC, DPWG, and FDA labelling. `;
          return {c:tpmtPM||nudtPM?"#dc2626":r.val.includes("IM")?"#ca8a04":"#16a34a",t:`${msg}${GUIDELINE_CLOSING}`};
        }
      },

    ]
  },

  // ─────────────────────────────────────────
  // I. RENAL FUNCTION & HEMODYNAMICS (#1–10),
  // ─────────────────────────────────────────
  {
    id:"s18", label:"Dialysis & Vascular Access",
    calcs:[
      {
        id:"crrt_dose", name:"CRRT Dose & Prescription", ref:"KDIGO AKI 2012 §5.7; Bellomo et al. (RENAL), NEJM 2009; VA/NIH ATN Network, NEJM 2008", tag:"CRRT — Effluent Dose Prescription",
        formula:"Effluent dose = (Dialysate flow + Replacement flow + UF) / Weight\nKDIGO recommends: 20-25 mL/kg/h delivered effluent dose\n  Prescribe 25-30 mL/kg/h to DELIVER 20-25 (accounting for downtime)\n\nModalities:\n  CVVH: Replacement fluid (pre/post-dilution)\n  CVVHD: Dialysate-based (diffusion)\n  CVVHDF: Combination (most common)",
        note:"ATN trial (NEJM 2008) and RENAL trial (NEJM 2009) showed no benefit to higher intensity (35-40 mL/kg/h) vs standard (20-25 mL/kg/h). Prescribe 25-30 to deliver 20-25 after downtime. Pre-dilution reduces filter clotting but dilutes efficiency (~15%). Citrate anticoagulation preferred over heparin in most patients. Drug dosing: many drugs removed by CRRT — pharmacist review essential.",
        inputs:[
          {id:"wt",label:"Patient Weight",unit:"kg",type:"number",ph:"80"},
          {id:"dialysate",label:"Dialysate Flow Rate",unit:"mL/h",type:"number",ph:"1000"},
          {id:"replacement",label:"Replacement Fluid Rate",unit:"mL/h",type:"number",ph:"1000"},
          {id:"uf",label:"Net Ultrafiltration Rate",unit:"mL/h",type:"number",ph:"100"},
          {id:"modality",label:"Modality",type:"select",options:["CVVH (haemofiltration)","CVVHD (haemodialysis)","CVVHDF (haemodiafiltration)"]},
          {id:"dilution",label:"Pre/Post-Dilution (for CVVH/CVVHDF)",type:"select",options:["Post-dilution","Pre-dilution (reduce efficiency ~15%)","Mixed (33% pre / 67% post)"]},
        ],
        compute(v){
          const wt=+v.wt,d=+v.dialysate,r=+v.replacement,u=+v.uf;
          if(!wt||wt<=0) return null;
          const total=d+r+u;
          const dose=total/wt;
          const preDilCorrection=v.dilution?.includes("Pre")?0.85:v.dilution?.includes("Mixed")?0.95:1.0;
          const effectiveDose=dose*preDilCorrection;
          return {val:effectiveDose.toFixed(1),unit:"mL/kg/h (effective)",sec:`Prescribed: ${dose.toFixed(1)} mL/kg/h | Total effluent: ${total} mL/h | Pre-dilution factor: ${preDilCorrection}`};
        },
        interpret(r,v){
          const dose=+r.val;
          if(dose<20) return {c:"#dc2626",t:`Effective dose ${r.val} mL/kg/h — BELOW KDIGO target (20-25). Increase flow rates. Inadequate solute clearance likely. ${GUIDELINE_CLOSING}`};
          if(dose<=25) return {c:"#16a34a",t:`Effective dose ${r.val} mL/kg/h — within KDIGO target (20-25). This is the evidence-based standard dose. Higher doses have not shown benefit (ATN/RENAL trials). ${GUIDELINE_CLOSING}`};
          if(dose<=30) return {c:"#16a34a",t:`Effective dose ${r.val} mL/kg/h — appropriate prescribing margin to deliver 20-25 after downtime. ${GUIDELINE_CLOSING}`};
          return {c:"#ca8a04",t:`Effective dose ${r.val} mL/kg/h — above 30. No mortality benefit from higher-intensity CRRT. Consider reducing to avoid electrolyte losses (phosphate, amino acids) and drug clearance issues. ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"pirrt", name:"PIRRT / SLED Prescription", ref:"Marshall et al., AJKD 2011; Edrees et al., Clin J Am Soc Nephrol 2016", tag:"Prolonged Intermittent RRT (SLED)",
        formula:"PIRRT (SLED): 6-12 hours, blood flow 150-250 mL/min, dialysate 100-300 mL/min\nKt/V target: ≥1.2 per session (or ≥3.9/week for alternate-day)\n\nAdvantages over CRRT:\n  - Less anticoagulation requirement\n  - Allows interruption-free diagnostics/procedures\n  - Comparable outcomes to CRRT in ICU-AKI",
        note:"GUIDELINE-BASED TOOL — This calculator applies published clinical thresholds but is not itself a validated composite scoring instrument. Interpret within clinical context.\n\nPIRRT/SLED bridges CRRT and conventional IHD. Haemodynamically better tolerated than IHD due to slower solute and fluid removal. Equivalent outcomes to CRRT in haemodynamically unstable patients (multiple RCTs). Typical prescription: Qb 150-250, Qd 100-300, session 6-12h, daily or alternate-day. Drug dosing similar to CRRT during treatment, IHD between sessions.",
        inputs:[
          {id:"qb",label:"Blood Flow Rate (Qb)",unit:"mL/min",type:"number",ph:"200"},
          {id:"qd",label:"Dialysate Flow Rate (Qd)",unit:"mL/min",type:"number",ph:"200"},
          {id:"duration",label:"Session Duration",unit:"hours",type:"number",ph:"8"},
          {id:"frequency",label:"Frequency",type:"select",options:["Daily","Alternate day","Three times/week"]},
          {id:"uf_target",label:"UF Target per session",unit:"mL",type:"number",ph:"2000"},
          {id:"wt_pirrt",label:"Patient Weight",unit:"kg",type:"number",ph:"75"},
        ],
        compute(v){
          const qb=+v.qb,qd=+v.qd,dur=+v.duration,uf=+v.uf_target,wt=+v.wt_pirrt;
          if(!qb||!qd||!dur) return null;
          const ufRate=uf&&dur?(uf/(dur*60)).toFixed(1):"N/A";
          return {val:`Qb ${qb} / Qd ${qd} / ${dur}h`,unit:v.frequency,sec:`UF rate: ${ufRate} mL/min | UF target: ${uf||"-"} mL | Weight: ${wt||"-"} kg`};
        },
        interpret(r,v){
          const qb=+v.qb,qd=+v.qd,dur=+v.duration,uf=+v.uf_target,wt=+v.wt_pirrt;
          const ufRate=uf&&dur?(uf/(dur*60)):0;
          let msg=`PIRRT/SLED prescription: Qb ${qb}, Qd ${qd}, ${dur}h sessions, ${v.frequency}. `;
          if(ufRate>13) msg+=`UF rate ${ufRate.toFixed(1)} mL/min/kg — HIGH. Consider extending session or reducing target to improve haemodynamic tolerance. `;
          if(qb<150) msg+=`Qb <150 mL/min — may limit clearance. `;
          if(dur<6) msg+=`Duration <6h approaches conventional IHD territory — consider extending for better haemodynamic stability. `;
          msg+=`Pharmacist review for drug dosing adjustments during PIRRT sessions. `;
          return {c:"#2563eb",t:`${msg}${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"ihd_ktv", name:"IHD Adequacy (Kt/V)", ref:"KDOQI HD Adequacy 2015; Daugirdas JT, JASN 1993", tag:"Intermittent HD — Delivered Dose",
        formula:"Single-pool Kt/V (Daugirdas 2nd gen):\nspKt/V = -ln(R - 0.008t) + (4 - 3.5R) × UF/W\nwhere R = post-BUN/pre-BUN, t = session time (h), UF = ultrafiltration (L), W = post-weight (kg)\n\nTargets (KDOQI 2015):\n  Minimum: spKt/V ≥1.2 per session (3×/week)\n  Target: spKt/V 1.4 (to ensure delivery ≥1.2)\n  URR target: ≥65%",
        note:"Daugirdas 2nd generation formula accounts for ultrafiltration and urea generation. Residual kidney function (Kr) contributes to total Kt/V in incident patients. KDOQI recommends minimum spKt/V 1.2 for 3×/week schedules. For 2×/week (with significant residual function): target stdKt/V ≥2.3/week.",
        inputs:[
          {id:"pre_bun",label:"Pre-Dialysis BUN",unit:"mg/dL",type:"number",ph:"65"},
          {id:"post_bun",label:"Post-Dialysis BUN",unit:"mg/dL",type:"number",ph:"22"},
          {id:"t_session",label:"Session Duration",unit:"hours",type:"number",ph:"4"},
          {id:"uf_vol",label:"Ultrafiltration Volume",unit:"L",type:"number",ph:"2.5"},
          {id:"post_wt",label:"Post-Dialysis Weight",unit:"kg",type:"number",ph:"70"},
        ],
        compute(v){
          const pre=+v.pre_bun,post=+v.post_bun,t=+v.t_session,uf=+v.uf_vol,w=+v.post_wt;
          if(!pre||!post||!t||!w||pre<=0||post<=0||post>=pre) return null;
          const R=post/pre;
          const ktv=-Math.log(R-0.008*t)+(4-3.5*R)*(uf/w);
          const urr=(1-R)*100;
          return {val:ktv.toFixed(2),unit:"spKt/V",sec:`URR: ${urr.toFixed(1)}% | R: ${R.toFixed(3)} | UF: ${uf}L`};
        },
        interpret(r){
          const ktv=+r.val;
          if(ktv>=1.4) return {c:"#16a34a",t:`spKt/V ${r.val} — Adequate (target ≥1.4 to reliably deliver ≥1.2). ${GUIDELINE_CLOSING}`};
          if(ktv>=1.2) return {c:"#ca8a04",t:`spKt/V ${r.val} — Meets minimum (≥1.2) but below 1.4 target. Consider increasing Qb, session time, or dialyser surface area. ${GUIDELINE_CLOSING}`};
          return {c:"#dc2626",t:`spKt/V ${r.val} — INADEQUATE (<1.2). Increase session time, blood flow, or dialyser efficiency. Check access recirculation. ${GUIDELINE_CLOSING}`};
        }
      },
      {
        id:"avf_maturation", name:"AV Fistula Maturation Assessment", ref:"KDOQI Vascular Access 2019 (Update); NKF-KDOQI 2006 Rule of 6s", tag:"Vascular Access — AVF Maturation",
        formula:"Rule of 6s (NKF-KDOQI) — AVF maturation criteria:\n  • Flow ≥600 mL/min\n  • Diameter ≥6 mm (vein)\n  • Depth ≤6 mm from skin surface\n  • Assessed ≥6 weeks post-creation\n  • Straight segment ≥6 cm for cannulation\n\nCreate AVF when eGFR <15-20 OR dialysis expected within 6-12 months\nAVF preferred over AVG preferred over CVC (Fistula First initiative)",
        note:"GUIDELINE-BASED TOOL — This calculator applies published clinical thresholds but is not itself a validated composite scoring instrument. Interpret within clinical context.\n\nKDOQI 2019 update recommends referral for access at eGFR <20 or expected dialysis within 12 months. AVF has lowest infection and thrombosis rates. Maturation failure rate: 28-53% (Dember et al., NEJM 2008). Consider Duplex US mapping pre-operatively. Radiocephalic preferred → brachiocephalic → brachiobasilic transposition → AVG. Avoid ipsilateral subclavian CVC if fistula planned.",
        inputs:[
          {id:"flow",label:"Access Flow (Qa)",unit:"mL/min",type:"number",ph:"750"},
          {id:"diameter",label:"Vein Diameter (on US)",unit:"mm",type:"number",ph:"5.5"},
          {id:"depth",label:"Depth from Skin Surface",unit:"mm",type:"number",ph:"4"},
          {id:"weeks",label:"Weeks Since Creation",unit:"weeks",type:"number",ph:"8"},
          {id:"segment",label:"Straight Cannulation Segment Length",unit:"cm",type:"number",ph:"7"},
          {id:"thrill",label:"Palpable thrill throughout",type:"checkbox"},
        ],
        compute(v){
          const flow=+v.flow,diam=+v.diameter,depth=+v.depth,wks=+v.weeks,seg=+v.segment;
          const criteria=[
            flow>=600,diam>=6,depth<=6,wks>=6,seg>=6
          ];
          const met=criteria.filter(Boolean).length;
          return {val:`${met}/5`,unit:"Rule of 6s criteria met",sec:`Flow: ${flow||"-"} | Diam: ${diam||"-"}mm | Depth: ${depth||"-"}mm | Wks: ${wks||"-"} | Segment: ${seg||"-"}cm | Thrill: ${v.thrill?"Yes":"No"}`};
        },
        interpret(r,v){
          const flow=+v.flow,diam=+v.diameter,depth=+v.depth,wks=+v.weeks;
          const met=parseInt(r.val)||0;
          if(met===5&&v.thrill) return {c:"#16a34a",t:`AVF mature — all Rule of 6s criteria met with palpable thrill. Suitable for cannulation. Begin two-needle dialysis. ${GUIDELINE_CLOSING}`};
          if(met>=3) return {c:"#ca8a04",t:`${r.val} criteria met. Partially mature. ${!v.thrill?"No thrill palpated — check for stenosis/thrombosis. ":""}${diam<6?"Vein diameter <6mm — may improve with exercise/time. ":""}${flow<600?"Flow <600 — consider fistulography if persistent. ":""}Repeat US in 2-4 weeks. ${GUIDELINE_CLOSING}`};
          if(wks<6) return {c:"#2563eb",t:`Only ${wks} weeks since creation. Allow ≥6 weeks for maturation. Encourage hand-grip exercises. Repeat assessment at 6 weeks. ${GUIDELINE_CLOSING}`};
          return {c:"#dc2626",t:`${r.val} criteria met — maturation failure likely. Consider fistuloplasty (balloon angioplasty), superficialisation, or revision. Duplex US to identify correctable stenosis. AVG or CVC may be needed as bridge. ${GUIDELINE_CLOSING}`};
        }
      },
    ]
  }
];


// ════════════════════════════════════════════
// MAIN COMPONENT
// ════════════════════════════════════════════
const allCalcs = SECTIONS.flatMap(s => s.calcs.map(c => ({...c, sid: s.id, slabel: s.label})));

function App() {
  const [accepted, setAccepted] = useState(false);
  const [sid, setSid] = useState("s1");
  const [cid, setCid] = useState("ckdepi");
  const [inputs, setInputs] = useState({});
  const [result, setResult] = useState(null);
  const [interp, setInterp] = useState(null);
  const [search, setSearch] = useState("");
  const [sidebarOpen, setSidebarOpen] = useState(true);

  const calc = allCalcs.find(c => c.id === cid);
  const sec = SECTIONS.find(s => s.id === sid);
  const found = search.trim() ? allCalcs.filter(c =>
    c.name.toLowerCase().includes(search.toLowerCase()) ||
    (c.tag||"").toLowerCase().includes(search.toLowerCase()) ||
    (c.ref||"").toLowerCase().includes(search.toLowerCase())
  ) : null;

  function pick(c) {
    setCid(c.id); setSid(c.sid);
    setInputs({}); setResult(null); setInterp(null); setSearch("");
  }
  function inp(id, val) { setInputs(p => ({...p, [id]: val})); setResult(null); setInterp(null); }
  function go() {
    if (!calc) return;
    const fi = {...inputs};
    calc.inputs.forEach(i => {
      if (i.type === "select" && (fi[i.id] === undefined || fi[i.id] === null || fi[i.id] === ""))
        fi[i.id] = i.options[0];
      if (i.type === "checkbox" && fi[i.id] === undefined)
        fi[i.id] = false;
    });
    let r;
    try { r = calc.compute(fi); } catch(e) { r = null; }
    if (r === null || r === undefined) {
      setResult(null);
      const missing = calc.inputs
        .filter(i => i.type === "number" && (!fi[i.id] || fi[i.id] === ""))
        .map(i => i.label.split("—")[0].split("(")[0].trim());
      const msg = missing.length > 0
        ? `Missing: ${missing.slice(0,3).join(", ")}${missing.length > 3 ? ` (+${missing.length-3} more)` : ""}. Please enter valid values.`
        : "Please enter valid values in all required fields.";
      setInterp({c:"#dc2626", t: msg});
      return;
    }
    setResult(r);
    setInterp(calc.interpret(r, fi));
  }
  function reset() { setInputs({}); setResult(null); setInterp(null); }

  // ── DISCLAIMER GATE ──
  if (!accepted) return (
    <div style={{minHeight:"100vh",background:"#f7f8fa",display:"flex",alignItems:"center",justifyContent:"center",padding:24,fontFamily:"'Georgia',serif"}}>
      <div style={{maxWidth:660,background:"#fff",border:"1px solid #e0e3ea",borderRadius:8,padding:"40px 44px",boxShadow:"0 2px 20px rgba(0,0,0,0.06)"}}>
        <div style={{fontSize:11,letterSpacing:"0.15em",color:"#999",textTransform:"uppercase",marginBottom:6,fontFamily:"'Courier New',monospace"}}>Important — Read Before Proceeding</div>
        <div style={{fontSize:20,fontWeight:700,color:"#111",marginBottom:4}}>Educational & Legal Disclaimer</div>
        <div style={{fontSize:11,color:"#bbb",marginBottom:20,fontFamily:"'Courier New',monospace"}}>© 2026 Dr. Ashish Patel. All rights reserved.</div>
        <div data-peer-review-1="" data-peer-review-2="" data-peer-review-3="" style={{display:"none"}}/>
        <div style={{maxHeight:340,overflowY:"auto",fontSize:12.5,color:"#444",lineHeight:1.85,marginBottom:28,paddingRight:8,whiteSpace:"pre-line",borderTop:"1px solid #f0f2f5",paddingTop:16}}>{DISCLAIMER_TEXT}</div>
        <div style={{borderTop:"1px solid #eee",paddingTop:20,display:"flex",justifyContent:"flex-end"}}>
          <button onClick={() => setAccepted(true)} style={{background:"#111",color:"#fff",border:"none",borderRadius:5,padding:"11px 32px",fontSize:13,cursor:"pointer",fontFamily:"'Courier New',monospace",letterSpacing:"0.06em",fontWeight:600}}>
            I UNDERSTAND — PROCEED
          </button>
        </div>
      </div>
    </div>
  );

  // ── MAIN APP ──
  return (
    <div style={{minHeight:"100vh",background:"#f7f8fa",fontFamily:"'Helvetica Neue','Arial',sans-serif",color:"#111",display:"flex",flexDirection:"column"}}>
      {/* Header */}
      <header style={{background:"#fff",borderBottom:"1px solid #e0e3ea",height:54,display:"flex",alignItems:"center",justifyContent:"space-between",padding:"0 20px",flexShrink:0,position:"sticky",top:0,zIndex:100}}>
        <div style={{display:"flex",alignItems:"center",gap:14}}>
          <button onClick={() => setSidebarOpen(o => !o)} style={{background:"none",border:"none",cursor:"pointer",fontSize:17,color:"#888",padding:"4px 6px",lineHeight:1}}>☰</button>
          <div style={{display:"flex",alignItems:"baseline",gap:10}}>
            <span style={{fontSize:15,fontWeight:700,color:"#111",letterSpacing:"-0.01em"}}>NephroCalc Pro — Renal & Clinical Decision Support</span>
            <span style={{fontSize:10,color:"#bbb",fontFamily:"'Courier New',monospace"}}>v10.0</span>
          </div>
        </div>
        <div style={{fontSize:10,color:"#bbb",fontFamily:"'Courier New',monospace",textAlign:"right",lineHeight:1.5}}>© 2026 Dr. Ashish Patel<br/>All rights reserved.<span data-peer-review-1="" data-peer-review-2="" data-peer-review-3="" style={{display:"none"}}/></div>
      </header>

      {/* Warning bar */}
      <div style={{background:"#fffbeb",borderBottom:"1px solid #fde68a",padding:"7px 20px",fontSize:11,color:"#92400e",display:"flex",gap:8,alignItems:"flex-start"}}>
        <span style={{marginTop:1}}>⚠</span>
        <span><strong>Clinical Decision Support Tool.</strong> All outputs support, not replace, independent clinical judgement. In emergencies, immediate resuscitation takes absolute precedence. © 2026 Dr. Ashish Patel.<span data-peer-review-1="" data-peer-review-2="" data-peer-review-3="" style={{display:"none"}}/></span>
      </div>

      <div style={{display:"flex",flex:1,overflow:"hidden",minHeight:0}}>
        {/* Sidebar */}
        {sidebarOpen && (
          <aside style={{width:260,background:"#fff",borderRight:"1px solid #e0e3ea",overflowY:"auto",flexShrink:0,display:"flex",flexDirection:"column"}}>
            <div style={{padding:"10px 12px",borderBottom:"1px solid #f0f2f5"}}>
              <input value={search} onChange={e => setSearch(e.target.value)} placeholder="Search all calculators…"
                style={{width:"100%",background:"#f7f8fa",border:"1px solid #e0e3ea",borderRadius:5,padding:"7px 10px",fontSize:12,color:"#333",outline:"none",boxSizing:"border-box",fontFamily:"inherit"}}/>
            </div>
            {search && found ? (
              <div>
                <div style={{padding:"8px 12px 4px",fontSize:10,color:"#aaa",letterSpacing:"0.1em",textTransform:"uppercase"}}>Results ({found.length})</div>
                {found.map(c => (
                  <div key={c.id} onClick={() => pick(c)} style={{padding:"8px 12px",cursor:"pointer",borderLeft:cid===c.id?"3px solid #111":"3px solid transparent",background:cid===c.id?"#f7f8fa":"transparent"}}>
                    <div style={{fontSize:10,color:"#aaa",marginBottom:1}}>{c.slabel}</div>
                    <div style={{fontSize:13,color:"#111",fontWeight:cid===c.id?600:400}}>{c.name}</div>
                    <div style={{fontSize:10,color:"#bbb"}}>{c.tag}</div>
                  </div>
                ))}
              </div>
            ) : SECTIONS.map(s => (
              <div key={s.id}>
                <div onClick={() => setSid(sid===s.id?"":s.id)} style={{padding:"9px 12px",cursor:"pointer",borderTop:"1px solid #f0f2f5",display:"flex",justifyContent:"space-between",alignItems:"center",background:sid===s.id?"#f7f8fa":"#fff"}}>
                  <span style={{fontSize:11,fontWeight:600,color:sid===s.id?"#111":"#666",letterSpacing:"0.02em",textTransform:"uppercase",lineHeight:1.3}}>{s.label}</span>
                  <span style={{fontSize:10,color:"#ccc"}}>{s.calcs.length}</span>
                </div>
                {sid===s.id && s.calcs.map(c => (
                  <div key={c.id} onClick={() => pick({...c,sid:s.id,slabel:s.label})} style={{padding:"7px 12px 7px 20px",cursor:"pointer",borderLeft:cid===c.id?"3px solid #111":"3px solid transparent",background:cid===c.id?"#f0f2f5":"transparent"}}>
                    <div style={{fontSize:13,color:cid===c.id?"#111":"#444",fontWeight:cid===c.id?600:400}}>{c.name}</div>
                    <div style={{fontSize:10,color:"#aaa",marginTop:1}}>{c.tag}</div>
                  </div>
                ))}
              </div>
            ))}
            <div style={{marginTop:"auto",padding:"14px 12px",borderTop:"1px solid #f0f2f5"}}>
              <div style={{fontSize:10,color:"#ccc",lineHeight:1.7,fontFamily:"'Courier New',monospace"}}>
                © 2026 Dr. Ashish Patel<br/>All rights reserved.
              </div>
            </div>
          </aside>
        )}

        {/* Main */}
        <main style={{flex:1,overflowY:"auto",padding:"28px 32px"}}>
          {calc && (
            <div style={{maxWidth:660}}>
              <div style={{marginBottom:26}}>
                <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:6,flexWrap:"wrap"}}>
                  <span style={{fontSize:10,background:"#f0f2f5",color:"#555",borderRadius:3,padding:"2px 8px",fontFamily:"'Courier New',monospace"}}>{calc.tag}</span>
                  <span style={{fontSize:10,color:"#bbb"}}>·</span>
                  <span style={{fontSize:10,color:"#bbb"}}>{sec?.label}</span>
                </div>
                <h1 style={{fontSize:22,fontWeight:700,color:"#111",margin:"0 0 3px",letterSpacing:"-0.02em"}}>{calc.name}</h1>
                <div style={{fontSize:11,color:"#999",marginBottom:12,fontFamily:"'Courier New',monospace"}}>{calc.ref}</div>

                <div style={{background:"#f7f8fa",border:"1px solid #e0e3ea",borderRadius:5,padding:"10px 14px",marginBottom:10}}>
                  <div style={{fontSize:9,color:"#bbb",letterSpacing:"0.12em",textTransform:"uppercase",marginBottom:4}}>Formula</div>
                  <div style={{fontSize:12,color:"#333",fontFamily:"'Courier New',monospace",lineHeight:1.7,whiteSpace:"pre-wrap"}}>{calc.formula}</div>
                </div>

                {calc.note && <div style={{fontSize:11.5,color:"#666",lineHeight:1.75,borderLeft:"3px solid #e0e3ea",paddingLeft:10,marginBottom:2}}>{calc.note}</div>}
              </div>

              <div style={{display:"grid",gap:12,marginBottom:22}}>
                {calc.inputs.map(i => (
                  <div key={i.id}>
                    {i.type==="checkbox" ? (
                      <label style={{display:"flex",alignItems:"flex-start",gap:9,cursor:"pointer",userSelect:"none"}}>
                        <input type="checkbox" checked={!!inputs[i.id]} onChange={e => inp(i.id, e.target.checked)}
                          style={{marginTop:2,width:14,height:14,accentColor:"#111",cursor:"pointer",flexShrink:0}}/>
                        <span style={{fontSize:13,color:inputs[i.id]?"#111":"#555",lineHeight:1.4}}>{i.label}</span>
                      </label>
                    ) : (
                      <>
                        <label style={{display:"block",fontSize:10,color:"#888",marginBottom:4,letterSpacing:"0.04em",textTransform:"uppercase"}}>
                          {i.label}{i.unit ? <span style={{color:"#ccc",fontWeight:400,textTransform:"none"}}> ({i.unit})</span>:""}
                        </label>
                        {i.type==="select" ? (
                          <select value={inputs[i.id]||i.options[0]} onChange={e => inp(i.id, e.target.value)}
                            style={{width:"100%",background:"#fff",border:"1px solid #d4d8e0",borderRadius:5,padding:"9px 11px",fontSize:13,color:"#111",outline:"none",fontFamily:"inherit",cursor:"pointer"}}>
                            {i.options.map(o => <option key={o} value={o}>{o}</option>)}
                          </select>
                        ) : (
                          <input type="number" value={inputs[i.id]||""} onChange={e => inp(i.id, e.target.value)} placeholder={i.ph}
                            style={{width:"100%",background:"#fff",border:"1px solid #d4d8e0",borderRadius:5,padding:"9px 11px",fontSize:13,color:"#111",outline:"none",fontFamily:"inherit",boxSizing:"border-box"}}/>
                        )}
                      </>
                    )}
                  </div>
                ))}
              </div>

              <div style={{display:"flex",gap:9,marginBottom:22}}>
                <button onClick={go} style={{background:"#111",color:"#fff",border:"none",borderRadius:5,padding:"10px 28px",fontSize:13,cursor:"pointer",fontFamily:"inherit",fontWeight:500}}>
                  Calculate
                </button>
                <button onClick={reset} style={{background:"#fff",color:"#555",border:"1px solid #d4d8e0",borderRadius:5,padding:"10px 18px",fontSize:13,cursor:"pointer",fontFamily:"inherit"}}>
                  Reset
                </button>
              </div>

              {result && (
                <div style={{background:"#fff",border:"1px solid #e0e3ea",borderRadius:6,padding:"16px 20px",marginBottom:10}}>
                  <div style={{fontSize:9,color:"#aaa",letterSpacing:"0.12em",textTransform:"uppercase",marginBottom:6}}>Result</div>
                  <div style={{display:"flex",alignItems:"baseline",gap:10,flexWrap:"wrap"}}>
                    <span style={{fontSize:34,fontWeight:700,color:"#111",letterSpacing:"-0.02em",lineHeight:1}}>{result.val}</span>
                    <span style={{fontSize:13,color:"#888"}}>{result.unit}</span>
                  </div>
                  {result.sec && <div style={{fontSize:11,color:"#aaa",marginTop:6,fontFamily:"'Courier New',monospace"}}>{result.sec}</div>}
                </div>
              )}

              {interp && (
                <div style={{borderLeft:`4px solid ${interp.c}`,background:"#fff",border:`1px solid ${interp.c}22`,borderLeftColor:interp.c,borderLeftWidth:4,borderRadius:"0 6px 6px 0",padding:"14px 18px",marginBottom:22}}>
                  <div style={{fontSize:9,color:"#aaa",letterSpacing:"0.12em",textTransform:"uppercase",marginBottom:6}}>Clinical Interpretation</div>
                  <div style={{fontSize:13,color:"#333",lineHeight:1.8}}>{interp.t}</div>
                </div>
              )}

              <div style={{fontSize:10.5,color:"#bbb",borderTop:"1px solid #f0f2f5",paddingTop:14,lineHeight:1.8}}>
                <strong style={{color:"#ccc"}}>Disclaimer:</strong> This tool supports clinical decision-making alongside, not in place of, a thorough clinical assessment. All outputs should be interpreted in context and in accordance with current applicable international and national guidelines and your institution's protocols. Source: {calc.ref}. <strong>© 2026 Dr. Ashish Patel. All rights reserved.</strong>
              </div>
            </div>
          )}
        </main>
      </div>
    </div>
  );
}



    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>